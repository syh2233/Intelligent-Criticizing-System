{% extends "base.html" %}

{% block content %}
  <div class="w-full max-w-4xl px-6">
    <!-- è€ƒè¯•åœºæ¬¡é€‰æ‹©å¯¼èˆªæ  -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">å½“å‰è€ƒè¯•åœºæ¬¡</h3>
        <div class="relative">
          <select id="session-selector" 
                  class="bg-input text-foreground border border-border rounded-md px-4 py-2 pr-8 appearance-none cursor-pointer">
            <option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>
          </select>
          <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
        </div>
      </div>
      <div id="current-session-info" class="text-muted-foreground text-sm hidden">
        <p>å·²é€‰æ‹©: <span id="selected-session-name" class="font-medium text-foreground"></span></p>
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-6">è¯•å·ä¸Šä¼ </h2>
      <!-- ä¸Šä¼ åŒºåŸŸå®¹å™¨ -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- è¯•å·å›¾ç‰‡ä¸Šä¼ æ¡† -->
        <div class="border border-border rounded-lg p-6 hover:border-primary transition-colors duration-200">
          <div class="flex flex-col items-center text-center">
            <span class="text-3xl mb-4">ğŸ“·</span>
            <h3 class="text-lg font-semibold mb-3">ä¸Šä¼ è¯•å·å›¾ç‰‡</h3>
            <p class="text-muted-foreground mb-4">æ”¯æŒ JPGã€PNG æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶æˆ–ZIPå‹ç¼©åŒ…</p>
            <input type="file" 
                   id="imageUpload" 
                   accept=".jpg,.jpeg,.png,.zip" 
                   class="hidden" 
                   multiple />
            <button onclick="document.getElementById('imageUpload').click()" 
                    class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 w-full">
              é€‰æ‹©æ–‡ä»¶
            </button>
          </div>
        </div>
        
        <!-- è¯•å·æ–‡æ¡£ä¸Šä¼ æ¡† -->
        <div class="border border-border rounded-lg p-6 hover:border-primary transition-colors duration-200">
          <div class="flex flex-col items-center text-center">
            <span class="text-3xl mb-4">ğŸ“„</span>
            <h3 class="text-lg font-semibold mb-3">ä¸Šä¼ è¯•å·æ–‡æ¡£</h3>
            <p class="text-muted-foreground mb-4">æ”¯æŒ DOCã€DOCX æ ¼å¼çš„æ–‡æ¡£æˆ–ZIPå‹ç¼©åŒ…</p>
            <input type="file" 
                   id="docUpload" 
                   accept=".doc,.docx,.zip" 
                   class="hidden" />
            <button onclick="document.getElementById('docUpload').click()" 
                    class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 w-full">
              é€‰æ‹©æ–‡ä»¶
            </button>
          </div>
        </div>
      </div>

      <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
      <div id="preview-container" class="mt-8 hidden">
        <h3 class="text-lg font-semibold mb-4">æ–‡ä»¶é¢„è§ˆ</h3>
        <div class="border border-border rounded-lg p-4">
          <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
          <div id="image-preview" class="hidden space-y-4">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-medium">å·²é€‰æ‹©çš„å›¾ç‰‡</h4>
              <button id="clear-images" 
                      class="text-sm text-destructive hover:text-destructive/80">
                æ¸…é™¤å…¨éƒ¨
              </button>
            </div>
            <div id="image-preview-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <!-- å›¾ç‰‡é¢„è§ˆé¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
            </div>
          </div>

          <!-- æ–‡ä»¶é¢„è§ˆåŒº -->
          <div id="file-preview" class="hidden">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-medium">å·²é€‰æ‹©çš„æ–‡ä»¶</h4>
              <button id="clear-file" 
                      class="text-sm text-destructive hover:text-destructive/80">
                æ¸…é™¤
              </button>
            </div>
            <div id="file-preview-content" class="space-y-4">
              <!-- æ–‡ä»¶ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨é˜…å·éƒ¨åˆ† -->
    <div class="mt-8">
      <h3 class="text-lg font-semibold mb-3">è‡ªåŠ¨é˜…å·</h3>
      <p class="text-muted-foreground mb-4">ç³»ç»Ÿè‡ªåŠ¨é˜…å·å¹¶ç”Ÿæˆåˆæ­¥æˆç»©ã€‚</p>
      <button id="startReading" 
              class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
        å¼€å§‹é˜…å·
      </button>
      <div class="w-full bg-muted rounded-full h-2.5">
        <div class="bg-primary h-2.5 rounded-full" style="width: 0%;" id="gradingProgress"></div>
      </div>
    </div>
  </div>

  <script>
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      const sessionSelector = document.getElementById('session-selector');
      const currentSessionInfo = document.getElementById('current-session-info');
      const selectedSessionName = document.getElementById('selected-session-name');
      const startReadingBtn = document.getElementById('startReading');
      
      // åŠ è½½è€ƒè¯•åœºæ¬¡
      async function loadExamSessions() {
        try {
          const response = await fetch('/api/exam-sessions');
          const sessions = await response.json();
          
          sessionSelector.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>';
          sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = session.session_name;
            sessionSelector.appendChild(option);
          });
        } catch (error) {
          console.error('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥:', error);
          alert('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥');
        }
      }
      
      // ç›‘å¬è€ƒè¯•åœºæ¬¡é€‰æ‹©
      sessionSelector.addEventListener('change', function() {
        if (this.value) {
          currentSessionInfo.classList.remove('hidden');
          selectedSessionName.textContent = this.options[this.selectedIndex].text;
          startReadingBtn.disabled = false;
        } else {
          currentSessionInfo.classList.add('hidden');
          selectedSessionName.textContent = '';
          startReadingBtn.disabled = true;
        }
      });
      
      let uploadedFiles = []; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶
      
      // å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„é€šç”¨å‡½æ•°
      async function handleFileUpload(files, type) {
        try {
          previewContainer.classList.remove('hidden');
          const preview = type === 'image' ? imagePreview : filePreview;
          const previewContent = type === 'image' ? imagePreviewGrid : filePreviewContent;
          
          preview.classList.remove('hidden');
          previewContent.innerHTML = '<div class="text-center">æ­£åœ¨å¤„ç†æ–‡ä»¶...</div>';

          const formData = new FormData();
          
          // å¤„ç†å•ä¸ªæ–‡ä»¶æˆ–å¤šä¸ªæ–‡ä»¶
          if (files.length === 1) {
            formData.append('file', files[0]);
          } else {
            // å¦‚æœæ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶zip
            for (let i = 0; i < files.length; i++) {
              formData.append(`file${i}`, files[i]);
            }
          }
          formData.append('type', type);

          const response = await fetch('/upload', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
          }

          const data = await response.json();

          // æ›´æ–°é¢„è§ˆåŒºåŸŸ
          if (type === 'image') {
            imagePreviewGrid.innerHTML = '';
            data.files.forEach(file => {
              const previewItem = document.createElement('div');
              previewItem.className = 'relative group';
              
              // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
              const img = document.createElement('img');
              img.className = 'w-full h-40 object-cover rounded-md';
              img.alt = file.original_name || file.name;
              
              // è®¾ç½®å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
              img.onerror = function() {
                console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.original_name || file.name}`);
                this.onerror = null;
                this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxsaW5lIHgxPSIxOCIgeTE9IjYiIHgyPSI2IiB5Mj0iMTgiPjwvbGluZT48bGluZSB4MT0iNiIgeTE9IjYiIHgyPSIxOCIgeTI9IjE4Ij48L2xpbmU+PC9zdmc+';
                this.classList.add('error-image');
                
                // æ·»åŠ é”™è¯¯æç¤º
                const errorText = document.createElement('div');
                errorText.className = 'absolute bottom-0 left-0 right-0 bg-red-500 text-white text-xs p-1 text-center';
                errorText.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                this.parentElement.appendChild(errorText);
              };
              
              // è®¾ç½®å›¾ç‰‡æº
              img.src = `/extracted_files/${data.extract_dir}/${file.path}`;
              
              // æ·»åŠ æ‚¬åœæ•ˆæœ
              const overlay = document.createElement('div');
              overlay.className = 'absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-md flex items-center justify-center';
              overlay.innerHTML = `<span class="text-white text-sm">${file.original_name || file.name}</span>`;
              
              previewItem.appendChild(img);
              previewItem.appendChild(overlay);
              imagePreviewGrid.appendChild(previewItem);
            });
          } else {
            filePreviewContent.innerHTML = data.files.map(file => `
              <div class="bg-muted p-4 rounded-md">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">ğŸ“„</span>
                  <div class="flex-grow">
                    <p class="font-medium">${file.original_name || file.name}</p>
                    <p class="text-sm text-muted-foreground">æ–‡æ¡£æ–‡ä»¶</p>
                  </div>
                </div>
              </div>
            `).join('');
          }

          // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯
          uploadedFiles = Array.from(files);
          startReadingBtn.disabled = false;

        } catch (error) {
          console.error('ä¸Šä¼ é”™è¯¯:', error);
          alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
          const previewContent = type === 'image' ? imagePreviewGrid : filePreviewContent;
          previewContent.innerHTML = '<div class="text-red-500">ä¸Šä¼ å¤±è´¥</div>';
        }
      }

      // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
      const imageUpload = document.getElementById('imageUpload');
      const previewContainer = document.getElementById('preview-container');
      const imagePreview = document.getElementById('image-preview');
      const imagePreviewGrid = document.getElementById('image-preview-grid');
      const clearImages = document.getElementById('clear-images');
      const filePreview = document.getElementById('file-preview');
      const filePreviewContent = document.getElementById('file-preview-content');

      imageUpload.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          await handleFileUpload(e.target.files, 'image');
        }
      });

      // å¤„ç†æ–‡æ¡£ä¸Šä¼ 
      const docUpload = document.getElementById('docUpload');
      docUpload.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          await handleFileUpload(e.target.files, 'document');
        }
      });

      // æ¸…é™¤å›¾ç‰‡
      clearImages.addEventListener('click', function() {
        imageUpload.value = '';
        imagePreview.classList.add('hidden');
        imagePreviewGrid.innerHTML = '';
        uploadedFiles = []; // æ¸…é™¤ä¿å­˜çš„æ–‡ä»¶
        if (filePreview.classList.contains('hidden')) {
          previewContainer.classList.add('hidden');
        }
        startReadingBtn.disabled = true;
      });

      // æ¸…é™¤æ–‡ä»¶
      const clearFile = document.getElementById('clear-file');
      clearFile.addEventListener('click', function() {
        docUpload.value = '';
        filePreview.classList.add('hidden');
        filePreviewContent.innerHTML = '';
        uploadedFiles = []; // æ¸…é™¤ä¿å­˜çš„æ–‡ä»¶
        if (imagePreview.classList.contains('hidden')) {
          previewContainer.classList.add('hidden');
        }
        startReadingBtn.disabled = true;
      });

      // è·å–æ–‡ä»¶å›¾æ ‡
      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
          'doc': 'ğŸ“„',
          'docx': 'ğŸ“„',
          'zip': 'ğŸ“¦',
          'rar': 'ğŸ“¦'
        };
        return icons[ext] || 'ğŸ“„';
      }

      // è·å–æ–‡ä»¶ç±»å‹æè¿°
      function getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const types = {
          'doc': 'Wordæ–‡æ¡£',
          'docx': 'Wordæ–‡æ¡£',
          'zip': 'å‹ç¼©åŒ…',
          'rar': 'å‹ç¼©åŒ…'
        };
        return types[ext] || 'æœªçŸ¥ç±»å‹';
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // å¼€å§‹é˜…å·
      startReadingBtn.addEventListener('click', async function() {
        if (!uploadedFiles.length && !sessionSelector.value) {
          alert('è¯·å…ˆé€‰æ‹©è€ƒè¯•åœºæ¬¡æˆ–ä¸Šä¼ è¯•å·æ–‡ä»¶');
          return;
        }

        try {
          this.disabled = true;
          this.textContent = 'é˜…å·ä¸­...';
          
          const progressBar = document.getElementById('gradingProgress');
          progressBar.style.width = '50%';

          // åˆ›å»º FormData å¯¹è±¡
          const formData = new FormData();
          
          // å¦‚æœæœ‰é€‰æ‹©è€ƒè¯•åœºæ¬¡
          if (sessionSelector.value) {
            formData.append('session_id', sessionSelector.value);
          }
          
          // å¦‚æœæœ‰ä¸Šä¼ æ–‡ä»¶
          if (uploadedFiles.length) {
            uploadedFiles.forEach((file, index) => {
              // ç¡®ä¿æ–‡ä»¶æ˜¯å›¾ç‰‡ç±»å‹
              if (file.type.startsWith('image/')) {
                formData.append(`file${index}`, file);
              }
            });
          }
          
          const response = await fetch('/api/start-grading', {
            method: 'POST',
            body: formData
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.success) {
            progressBar.style.width = '100%';
            alert('é˜…å·å®Œæˆï¼');
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            imageUpload.value = '';
            imagePreview.classList.add('hidden');
            imagePreviewGrid.innerHTML = '';
            uploadedFiles = [];
            if (filePreview.classList.contains('hidden')) {
              previewContainer.classList.add('hidden');
            }
            // é‡æ–°åŠ è½½è€ƒè¯•åœºæ¬¡
            await loadExamSessions();
            // é‡ç½®é€‰æ‹©
            currentSessionInfo.classList.add('hidden');
            selectedSessionName.textContent = '';
            sessionSelector.value = '';
          } else {
            throw new Error(data.message || 'é˜…å·å¤±è´¥');
          }
        } catch (error) {
          console.error('é˜…å·é”™è¯¯:', error);
          alert('é˜…å·è¿‡ç¨‹å‡ºç°é”™è¯¯: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = 'å¼€å§‹é˜…å·';
          progressBar.style.width = '0%';
        }
      });
      
      // åˆå§‹åŠ è½½è€ƒè¯•åœºæ¬¡
      loadExamSessions();
      // åˆå§‹ç¦ç”¨å¼€å§‹é˜…å·æŒ‰é’®
      startReadingBtn.disabled = true;
    });
  </script>
{% endblock %}