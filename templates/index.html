{% extends "base.html" %}

<!-- æ·»åŠ PDF-libåº“ï¼Œç¡®ä¿åŠ è½½å®Œæˆ -->
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/jszip@3.7.1/dist/jszip.min.js"></script>

{% block content %}
  <div class="w-full max-w-4xl px-6">
    <!-- åœ¨é¡µé¢æœ€å¼€å§‹æ·»åŠ è„šæœ¬åŠ è½½ -->
    <script>
      // ç¡®ä¿PDF-libåº“åŠ è½½
      function loadScript(url) {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      // åŠ è½½æ‰€éœ€çš„åº“
      Promise.all([
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js'),
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js')
      ]).catch(error => {
        console.error('åº“åŠ è½½å¤±è´¥:', error);
        alert('é¡µé¢èµ„æºåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
      });
    </script>

    <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <div class="mb-8">
      <div class="inline-flex rounded-lg border border-border p-1">
        <button id="upload-mode-btn"
                class="px-4 py-2 rounded-md text-sm font-medium mode-btn active">
          è¯•å·ä¸Šä¼ æ¨¡å¼
        </button>
        <button id="camera-mode-btn"
                class="px-4 py-2 rounded-md text-sm font-medium mode-btn">
          è‡ªåŠ¨æ‹æ‘„æ¨¡å¼
        </button>
      </div>
    </div>

    <!-- è€ƒè¯•åœºæ¬¡é€‰æ‹©å¯¼èˆªæ  -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">å½“å‰è€ƒè¯•åœºæ¬¡</h3>
        <div class="relative">
          <select id="session-selector"
                  class="bg-input text-foreground border border-border rounded-md px-4 py-2 pr-8 appearance-none cursor-pointer">
            <option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>
          </select>
          <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
        </div>
      </div>
      <div id="current-session-info" class="text-muted-foreground text-sm hidden">
        <p>å·²é€‰æ‹©: <span id="selected-session-name" class="font-medium text-foreground"></span></p>
      </div>
    </div>

    <!-- è¯•å·ä¸Šä¼ æ¨¡å¼å†…å®¹ -->
    <div id="upload-mode-content">
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6">è¯•å·ä¸Šä¼ </h2>
        <!-- ä¸Šä¼ åŒºåŸŸå®¹å™¨ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- è¯•å·å›¾ç‰‡ä¸Šä¼ æ¡† -->
          <div class="border border-border rounded-lg p-6 hover:border-primary transition-colors duration-200">
            <div class="flex flex-col items-center text-center">
              <span class="text-3xl mb-4">ğŸ“·</span>
              <h3 class="text-lg font-semibold mb-3">ä¸Šä¼ è¯•å·å›¾ç‰‡</h3>
              <p class="text-muted-foreground mb-4">æ”¯æŒ JPGã€PNG æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶æˆ–ZIPå‹ç¼©åŒ…</p>
              <input type="file"
                     id="imageUpload"
                     accept=".jpg,.jpeg,.png,.zip"
                     class="hidden"
                     multiple />
              <button onclick="document.getElementById('imageUpload').click()"
                      class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 w-full">
                é€‰æ‹©æ–‡ä»¶
              </button>
            </div>
          </div>

          <!-- è¯•å·æ–‡æ¡£ä¸Šä¼ æ¡† -->
          <div class="border border-border rounded-lg p-6 hover:border-primary transition-colors duration-200">
            <div class="flex flex-col items-center text-center">
              <span class="text-3xl mb-4">ğŸ“„</span>
              <h3 class="text-lg font-semibold mb-3">ä¸Šä¼ è¯•å·æ–‡æ¡£</h3>
              <p class="text-muted-foreground mb-4">æ”¯æŒ DOCã€DOCX æ ¼å¼çš„æ–‡æ¡£æˆ–ZIPå‹ç¼©åŒ…</p>
              <input type="file"
                     id="docUpload"
                     accept=".doc,.docx,.zip"
                     class="hidden" />
              <button onclick="document.getElementById('docUpload').click()"
                      class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 w-full">
                é€‰æ‹©æ–‡ä»¶
              </button>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶é¢„è§ˆåŒºåŸŸ -->
        <div id="preview-container" class="mt-8 hidden">
          <h3 class="text-lg font-semibold mb-4">æ–‡ä»¶é¢„è§ˆ</h3>
          <div class="border border-border rounded-lg p-4">
            <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
            <div id="image-preview" class="hidden space-y-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium">å·²é€‰æ‹©çš„å›¾ç‰‡</h4>
                <button id="clear-images"
                        class="text-sm text-destructive hover:text-destructive/80">
                  æ¸…é™¤å…¨éƒ¨
                </button>
              </div>
              <div id="image-preview-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- å›¾ç‰‡é¢„è§ˆé¡¹ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
              </div>
            </div>

            <!-- æ–‡ä»¶é¢„è§ˆåŒº -->
            <div id="file-preview" class="hidden">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-medium">å·²é€‰æ‹©çš„æ–‡ä»¶</h4>
                <button id="clear-file"
                        class="text-sm text-destructive hover:text-destructive/80">
                  æ¸…é™¤
                </button>
              </div>
              <div id="file-preview-content" class="space-y-4">
                <!-- æ–‡ä»¶ä¿¡æ¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨æ‹æ‘„æ¨¡å¼å†…å®¹ -->
    <div id="camera-mode-content" class="hidden">
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6">è‡ªåŠ¨æ‹æ‘„æ¨¡å¼</h2>
        <div class="border border-border rounded-lg p-6">
          <div class="flex flex-col items-center">
            <!-- æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ -->
            <div id="camera-preview" class="w-full max-w-2xl mb-6 bg-muted rounded-lg overflow-hidden">
              <video id="video" class="w-full h-auto" autoplay playsinline></video>
              <canvas id="canvas" class="hidden"></canvas>
            </div>

            <!-- æ‹æ‘„æ§åˆ¶æŒ‰é’® -->
            <div class="flex space-x-4">
              <button id="start-camera"
                      class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
                å¼€å¯é«˜æ‹ä»ª
              </button>
              <button id="capture-photo"
                      class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200"
                      disabled>
                æ‹æ‘„ç…§ç‰‡
              </button>
              <button id="save-photo"
                      class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200"
                      disabled>
                ä¿å­˜ç…§ç‰‡
              </button>
              <button id="stop-camera"
                      class="bg-destructive text-destructive-foreground px-6 py-2 rounded-md hover:bg-destructive/80 transition-colors duration-200"
                      disabled>
                å…³é—­é«˜æ‹ä»ª
              </button>
            </div>

            <!-- æ‹æ‘„é¢„è§ˆåŒºåŸŸ -->
            <div id="captured-photos" class="mt-8 w-full">
              <h3 class="text-lg font-semibold mb-4">å·²æ‹æ‘„ç…§ç‰‡</h3>
              <div id="photo-preview-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- æ‹æ‘„çš„ç…§ç‰‡å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- è‡ªåŠ¨é˜…å·éƒ¨åˆ† -->
    <div class="mt-8">
      <h3 class="text-lg font-semibold mb-3">è‡ªåŠ¨é˜…å·</h3>
      <p class="text-muted-foreground mb-4">ç³»ç»Ÿè‡ªåŠ¨é˜…å·å¹¶ç”Ÿæˆåˆæ­¥æˆç»©ã€‚</p>
      <button id="startReading"
              class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 mb-4 disabled:opacity-50 disabled:cursor-not-allowed">
        å¼€å§‹é˜…å·
      </button>
      <div class="w-full bg-muted rounded-full h-2.5">
        <div class="bg-primary h-2.5 rounded-full" style="width: 0%;" id="gradingProgress"></div>
      </div>
    </div>
  </div>

  <style>
    .mode-btn {
      transition: all 0.2s;
    }
    .mode-btn.active {
      background-color: hsl(var(--primary));
      color: hsl(var(--primary-foreground));
    }
  </style>

  <script>
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      const sessionSelector = document.getElementById('session-selector');
      const currentSessionInfo = document.getElementById('current-session-info');
      const selectedSessionName = document.getElementById('selected-session-name');
      const startReadingBtn = document.getElementById('startReading');

      // æ·»åŠ æ¨¡å¼åˆ‡æ¢çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
      const uploadModeBtn = document.getElementById('upload-mode-btn');
      const cameraModeBtn = document.getElementById('camera-mode-btn');
      const uploadContent = document.getElementById('upload-mode-content');
      const cameraContent = document.getElementById('camera-mode-content');

      // åˆ‡æ¢åˆ°ä¸Šä¼ æ¨¡å¼
      uploadModeBtn.addEventListener('click', function() {
        uploadModeBtn.classList.add('active');
        cameraModeBtn.classList.remove('active');
        uploadContent.classList.remove('hidden');
        cameraContent.classList.add('hidden');

        // å¦‚æœç›¸æœºå·²æ‰“å¼€ï¼Œåˆ™å…³é—­
        stopCamera();
      });

      // åˆ‡æ¢åˆ°ç›¸æœºæ¨¡å¼
      cameraModeBtn.addEventListener('click', function() {
        uploadModeBtn.classList.remove('active');
        cameraModeBtn.classList.add('active');
        uploadContent.classList.add('hidden');
        cameraContent.classList.remove('hidden');
      });

      // åŠ è½½è€ƒè¯•åœºæ¬¡
      async function loadExamSessions() {
        try {
          const response = await fetch('/api/exam-sessions');
          const sessions = await response.json();

          sessionSelector.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>';
          sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.id;
            option.textContent = session.session_name;
            sessionSelector.appendChild(option);
          });
        } catch (error) {
          console.error('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥:', error);
          alert('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥');
        }
      }

      // ç›‘å¬è€ƒè¯•åœºæ¬¡é€‰æ‹©
      sessionSelector.addEventListener('change', function() {
        if (this.value) {
          currentSessionInfo.classList.remove('hidden');
          selectedSessionName.textContent = this.options[this.selectedIndex].text;
          startReadingBtn.disabled = false;
        } else {
          currentSessionInfo.classList.add('hidden');
          selectedSessionName.textContent = '';
          startReadingBtn.disabled = true;
        }
      });

      let uploadedFiles = []; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶

      // å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„é€šç”¨å‡½æ•°
      async function handleFileUpload(files, type) {
        try {
          previewContainer.classList.remove('hidden');
          const preview = type === 'image' ? imagePreview : filePreview;
          const previewContent = type === 'image' ? imagePreviewGrid : filePreviewContent;

          preview.classList.remove('hidden');
          previewContent.innerHTML = '<div class="text-center">æ­£åœ¨å¤„ç†æ–‡ä»¶...</div>';

          const formData = new FormData();

          // å¤„ç†å•ä¸ªæ–‡ä»¶æˆ–å¤šä¸ªæ–‡ä»¶
          if (files.length === 1) {
            formData.append('file', files[0]);
          } else {
            // å¦‚æœæ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«æ·»åŠ åˆ°formData
            for (let i = 0; i < files.length; i++) {
              formData.append(`file${i}`, files[i]);
            }
          }
          formData.append('type', type);

          // å‘é€è¯·æ±‚å‰æ·»åŠ è°ƒè¯•ä¿¡æ¯
          console.log(`å‡†å¤‡ä¸Šä¼  ${files.length} ä¸ª${type}æ–‡ä»¶`);

          const response = await fetch('/upload', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'ä¸Šä¼ å¤±è´¥');
          }

          const data = await response.json();
          console.log('ä¸Šä¼ å“åº”:', data);

          // æ›´æ–°é¢„è§ˆåŒºåŸŸ
          if (type === 'image') {
            imagePreviewGrid.innerHTML = '';
            data.files.forEach(file => {
              const previewItem = document.createElement('div');
              previewItem.className = 'relative group';

              // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
              const img = document.createElement('img');
              img.className = 'w-full h-40 object-cover rounded-md';
              img.alt = file.original_name || file.name;

              // è®¾ç½®å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
              img.onerror = function() {
                console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${file.original_name || file.name}`);
                this.onerror = null;
                this.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxsaW5lIHgxPSIxOCIgeTE9IjYiIHgyPSI2IiB5Mj0iMTgiPjwvbGluZT48bGluZSB4MT0iNiIgeTE9IjYiIHgyPSIxOCIgeTI9IjE4Ij48L2xpbmU+PC9zdmc+';
                this.classList.add('error-image');

                // æ·»åŠ é”™è¯¯æç¤º
                const errorText = document.createElement('div');
                errorText.className = 'absolute bottom-0 left-0 right-0 bg-red-500 text-white text-xs p-1 text-center';
                errorText.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                this.parentElement.appendChild(errorText);
              };

              // è®¾ç½®å›¾ç‰‡æº
              img.src = `/extracted_files/${data.extract_dir}/${file.path}`;

              // æ·»åŠ æ‚¬åœæ•ˆæœ
              const overlay = document.createElement('div');
              overlay.className = 'absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-md flex items-center justify-center';
              overlay.innerHTML = `<span class="text-white text-sm">${file.original_name || file.name}</span>`;

              previewItem.appendChild(img);
              previewItem.appendChild(overlay);
              imagePreviewGrid.appendChild(previewItem);
            });
          } else {
            filePreviewContent.innerHTML = data.files.map(file => `
              <div class="bg-muted p-4 rounded-md">
                <div class="flex items-center space-x-3">
                  <span class="text-2xl">ğŸ“„</span>
                  <div class="flex-grow">
                    <p class="font-medium">${file.original_name || file.name}</p>
                    <p class="text-sm text-muted-foreground">æ–‡æ¡£æ–‡ä»¶</p>
                  </div>
                </div>
              </div>
            `).join('');
          }

          // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶ä¿¡æ¯
          uploadedFiles = Array.from(files);
          startReadingBtn.disabled = false;

        } catch (error) {
          console.error('ä¸Šä¼ é”™è¯¯:', error);
          alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
          const previewContent = type === 'image' ? imagePreviewGrid : filePreviewContent;
          previewContent.innerHTML = '<div class="text-red-500">ä¸Šä¼ å¤±è´¥</div>';
        }
      }

      // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
      const imageUpload = document.getElementById('imageUpload');
      const previewContainer = document.getElementById('preview-container');
      const imagePreview = document.getElementById('image-preview');
      const imagePreviewGrid = document.getElementById('image-preview-grid');
      const clearImages = document.getElementById('clear-images');
      const filePreview = document.getElementById('file-preview');
      const filePreviewContent = document.getElementById('file-preview-content');

      imageUpload.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          await handleFileUpload(e.target.files, 'image');
        }
      });

      // å¤„ç†æ–‡æ¡£ä¸Šä¼ 
      const docUpload = document.getElementById('docUpload');
      docUpload.addEventListener('change', async function(e) {
        if (e.target.files.length > 0) {
          await handleFileUpload(e.target.files, 'document');
        }
      });

      // æ¸…é™¤å›¾ç‰‡
      clearImages.addEventListener('click', function() {
        imageUpload.value = '';
        imagePreview.classList.add('hidden');
        imagePreviewGrid.innerHTML = '';
        uploadedFiles = []; // æ¸…é™¤ä¿å­˜çš„æ–‡ä»¶
        if (filePreview.classList.contains('hidden')) {
          previewContainer.classList.add('hidden');
        }
        startReadingBtn.disabled = true;
      });

      // æ¸…é™¤æ–‡ä»¶
      const clearFile = document.getElementById('clear-file');
      clearFile.addEventListener('click', function() {
        docUpload.value = '';
        filePreview.classList.add('hidden');
        filePreviewContent.innerHTML = '';
        uploadedFiles = []; // æ¸…é™¤ä¿å­˜çš„æ–‡ä»¶
        if (imagePreview.classList.contains('hidden')) {
          previewContainer.classList.add('hidden');
        }
        startReadingBtn.disabled = true;
      });

      // è·å–æ–‡ä»¶å›¾æ ‡
      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
          'doc': 'ğŸ“„',
          'docx': 'ğŸ“„',
          'zip': 'ğŸ“¦',
          'rar': 'ğŸ“¦'
        };
        return icons[ext] || 'ğŸ“„';
      }

      // è·å–æ–‡ä»¶ç±»å‹æè¿°
      function getFileType(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const types = {
          'doc': 'Wordæ–‡æ¡£',
          'docx': 'Wordæ–‡æ¡£',
          'zip': 'å‹ç¼©åŒ…',
          'rar': 'å‹ç¼©åŒ…'
        };
        return types[ext] || 'æœªçŸ¥ç±»å‹';
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // ä¿®æ”¹å¼€å§‹é˜…å·å‡½æ•°ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼çš„æ–‡ä»¶
      startReadingBtn.addEventListener('click', async function() {
        // æ ¹æ®å½“å‰æ¨¡å¼é€‰æ‹©ä¸åŒçš„å¤„ç†å‡½æ•°
        const currentMode = document.getElementById('camera-mode-content').classList.contains('hidden') ? 'upload' : 'camera';

        if (currentMode === 'upload') {
          await handleUploadModeGrading();
        } else {
          await handleCameraModeGrading();
        }
      });

      // ä¸Šä¼ æ¨¡å¼çš„é˜…å·å¤„ç†
      async function handleUploadModeGrading() {
        if (!sessionSelector.value) {
          alert('è¯·å…ˆé€‰æ‹©è€ƒè¯•åœºæ¬¡');
          return;
        }

        const hasUploadedFiles = uploadedFiles.length > 0;

        if (!hasUploadedFiles) {
          alert('è¯·å…ˆä¸Šä¼ è¯•å·');
          return;
        }

        const progressBar = document.getElementById('gradingProgress');
        
        try {
          startReadingBtn.disabled = true;
          startReadingBtn.textContent = 'é˜…å·ä¸­...';

          progressBar.style.width = '50%';

          const formData = new FormData();
          formData.append('session_id', sessionSelector.value);

          // æ·»åŠ ä¸Šä¼ çš„æ–‡ä»¶
          uploadedFiles.forEach((file, index) => {
            if (file.type.startsWith('image/')) {
              formData.append(`file${index}`, file);
            }
          });

          const response = await fetch('/api/start-grading', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.success) {
            progressBar.style.width = '100%';
            alert('é˜…å·å®Œæˆï¼');
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            resetUploadState();
            // é‡æ–°åŠ è½½è€ƒè¯•åœºæ¬¡
            await loadExamSessions();
          } else {
            throw new Error(data.message || 'é˜…å·å¤±è´¥');
          }
        } catch (error) {
          console.error('é˜…å·é”™è¯¯:', error);
          alert('é˜…å·è¿‡ç¨‹å‡ºç°é”™è¯¯: ' + error.message);
        } finally {
          startReadingBtn.disabled = false;
          startReadingBtn.textContent = 'å¼€å§‹é˜…å·';
          progressBar.style.width = '0%';
        }
      }

      // è‡ªåŠ¨æ‹æ‘„æ¨¡å¼çš„é˜…å·å¤„ç†
      async function handleCameraModeGrading() {
        if (!sessionSelector.value) {
          alert('è¯·å…ˆé€‰æ‹©è€ƒè¯•åœºæ¬¡');
          return;
        }

        const hasCapturedPhotos = capturedPhotos.length > 0;

        if (!hasCapturedPhotos) {
          alert('è¯·å…ˆæ‹æ‘„è¯•å·ç…§ç‰‡');
          return;
        }

        try {
          // æ£€æŸ¥PDF-libæ˜¯å¦å¯ç”¨
          if (typeof PDFLib === 'undefined') {
            // å°è¯•é‡æ–°åŠ è½½åº“
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js');
            // å†æ¬¡æ£€æŸ¥
            if (typeof PDFLib === 'undefined') {
              throw new Error('PDFå¤„ç†åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
          }

          startReadingBtn.disabled = true;
          startReadingBtn.textContent = 'é˜…å·ä¸­...';

          const progressBar = document.getElementById('gradingProgress');
          if (!progressBar) {
            console.error('æ‰¾ä¸åˆ°è¿›åº¦æ¡å…ƒç´ ');
            throw new Error('è¿›åº¦æ¡å…ƒç´ æœªæ‰¾åˆ°');
          }

          progressBar.style.width = '25%';

          // åˆ›å»ºPDFæ–‡æ¡£
          const pdfDoc = await PDFLib.PDFDocument.create();

          // å¤„ç†æ¯å¼ ç…§ç‰‡
          for (const photo of capturedPhotos) {
            try {
              console.log('å¤„ç†ç…§ç‰‡:', photo.name);
              const imageBytes = await photo.arrayBuffer();
              let image;

              if (photo.type === 'image/jpeg') {
                image = await pdfDoc.embedJpg(imageBytes);
              } else if (photo.type === 'image/png') {
                image = await pdfDoc.embedPng(imageBytes);
              } else {
                console.warn(`è·³è¿‡ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${photo.type}`);
                continue;
              }

              // åˆ›å»ºé¡µé¢ï¼Œä½¿ç”¨æ—‹è½¬åçš„å°ºå¯¸
              const page = pdfDoc.addPage([image.height, image.width]);

              // è®¡ç®—ç»˜åˆ¶ä½ç½®
              // å°†å›¾ç‰‡ç§»åŠ¨åˆ°é¡µé¢ä¸­å¿ƒå¹¶å‘å·¦æ—‹è½¬90åº¦
              page.drawImage(image, {
                x: 0,  // ä¿®æ”¹xåæ ‡ä¸º0
                y: image.width,  // ä¿®æ”¹yåæ ‡ä¸ºå›¾ç‰‡å®½åº¦
                width: image.width,
                height: image.height,
                rotate: PDFLib.degrees(-90),  // æ”¹ä¸º-90åº¦å®ç°å‘å·¦æ—‹è½¬
                xSkew: PDFLib.degrees(0),
                ySkew: PDFLib.degrees(0)
              });

              console.log('ç…§ç‰‡å·²æ·»åŠ åˆ°PDFå¹¶å‘å·¦æ—‹è½¬90åº¦');
            } catch (err) {
              console.error('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:', err);
              throw new Error(`å¤„ç†å›¾ç‰‡å¤±è´¥: ${err.message}`);
            }
          }

          progressBar.style.width = '50%';
          console.log('æ‰€æœ‰ç…§ç‰‡å¤„ç†å®Œæˆï¼Œå‡†å¤‡ç”ŸæˆPDF');

          // ç”ŸæˆPDFæ–‡ä»¶
          const pdfBytes = await pdfDoc.save();
          const pdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
          const pdfFile = new File([pdfBlob], `exam_${Date.now()}.pdf`, { type: 'application/pdf' });
          console.log('å¼€å§‹ç”ŸæˆPDF...');
          console.log('PDFç”Ÿæˆå®Œæˆï¼Œå¤§å°:', pdfBytes.length);
          console.log('å‡†å¤‡ä¸Šä¼ æ–‡ä»¶:', pdfFile.name);

          // å‡†å¤‡ä¸Šä¼ æ•°æ®
          const formData = new FormData();
          formData.append('session_id', sessionSelector.value);
          formData.append('pdf_file', pdfFile, pdfFile.name);

          console.log('å¼€å§‹ä¸Šä¼ PDFæ–‡ä»¶');
          const response = await fetch('/api/camera-mode-grading', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('ä¸Šä¼ å¤±è´¥:', errorText);
            throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${errorText}`);
          }

          const data = await response.json();
          if (!data.success) {
            throw new Error(data.message || 'å¤„ç†å¤±è´¥');
          }

          progressBar.style.width = '100%';
          alert('é˜…å·å®Œæˆï¼');
          resetUploadState();
          await loadExamSessions();
        } catch (error) {
          console.error('å¤„ç†é”™è¯¯:', error);
          alert(`å¤„ç†å¤±è´¥: ${error.message}`);
        } finally {
          startReadingBtn.disabled = false;
          startReadingBtn.textContent = 'å¼€å§‹é˜…å·';
          if (progressBar) {
            progressBar.style.width = '0%';
          }
        }
      }

      // é‡ç½®ä¸Šä¼ çŠ¶æ€
      function resetUploadState() {
        // é‡ç½®æ–‡ä»¶ä¸Šä¼ 
        imageUpload.value = '';
        imagePreview.classList.add('hidden');
        imagePreviewGrid.innerHTML = '';
        uploadedFiles = [];
        if (filePreview.classList.contains('hidden')) {
          previewContainer.classList.add('hidden');
        }

        // é‡ç½®æ‹æ‘„çš„ç…§ç‰‡
        photoPreviewGrid.innerHTML = '';
        capturedPhotos = [];

        // é‡ç½®è€ƒè¯•åœºæ¬¡é€‰æ‹©
        currentSessionInfo.classList.add('hidden');
        selectedSessionName.textContent = '';
        sessionSelector.value = '';

        // ç¦ç”¨å¼€å§‹é˜…å·æŒ‰é’®
        startReadingBtn.disabled = true;
      }

      // æ‘„åƒå¤´ç›¸å…³åŠŸèƒ½
      let stream = null;
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const startCameraBtn = document.getElementById('start-camera');
      const capturePhotoBtn = document.getElementById('capture-photo');
      const stopCameraBtn = document.getElementById('stop-camera');
      const photoPreviewGrid = document.getElementById('photo-preview-grid');
      let capturedPhotos = [];

      // å¼€å¯æ‘„åƒå¤´
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: 'environment',
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          });
          video.srcObject = stream;
          await video.play(); // ç¡®ä¿è§†é¢‘å¼€å§‹æ’­æ”¾

          // è®¾ç½® canvas å°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;

          startCameraBtn.disabled = true;
          capturePhotoBtn.disabled = false;
          stopCameraBtn.disabled = false;
          savePhotoBtn.disabled = true;
        } catch (err) {
          console.error('é«˜æ‹ä»ªå¯åŠ¨å¤±è´¥:', err);
          alert('æ— æ³•è®¿é—®é«˜æ‹ä»ªï¼Œè¯·ç¡®ä¿è®¾å¤‡å·²æ­£ç¡®è¿æ¥å¹¶æˆäºˆæƒé™ã€‚');
        }
      }

      // åœæ­¢æ‘„åƒå¤´
      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          video.srcObject = null;
          stream = null;
        }

        startCameraBtn.disabled = false;
        capturePhotoBtn.disabled = true;
        stopCameraBtn.disabled = true;
        savePhotoBtn.disabled = true;
      }

      // æ‹æ‘„ç…§ç‰‡
      function capturePhoto() {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // å°†ç…§ç‰‡è½¬æ¢ä¸ºæ–‡ä»¶å¯¹è±¡
        canvas.toBlob(blob => {
          const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
          capturedPhotos.push(file);

          // æ·»åŠ é¢„è§ˆ
          const previewItem = document.createElement('div');
          previewItem.className = 'relative group';

          const img = document.createElement('img');
          img.className = 'w-full h-40 object-cover rounded-md';
          img.src = URL.createObjectURL(file);

          const overlay = document.createElement('div');
          overlay.className = 'absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity duration-200 rounded-md flex items-center justify-center gap-2';

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'text-white bg-red-500 px-3 py-1 rounded-md text-sm';
          deleteBtn.textContent = 'åˆ é™¤';
          deleteBtn.onclick = () => {
            const index = capturedPhotos.indexOf(file);
            if (index > -1) {
              capturedPhotos.splice(index, 1);
              previewItem.remove();

              // å¦‚æœæ²¡æœ‰ç…§ç‰‡äº†ï¼Œç¦ç”¨ç›¸å…³æŒ‰é’®
              if (capturedPhotos.length === 0) {
                startReadingBtn.disabled = true;
                savePhotoBtn.disabled = true;
              }
            }
          };

          const downloadBtn = document.createElement('button');
          downloadBtn.className = 'text-white bg-green-500 px-3 py-1 rounded-md text-sm';
          downloadBtn.textContent = 'ä¸‹è½½';
          downloadBtn.onclick = () => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(file);
            link.download = file.name;
            link.click();
          };

          overlay.appendChild(deleteBtn);
          overlay.appendChild(downloadBtn);
          previewItem.appendChild(img);
          previewItem.appendChild(overlay);
          photoPreviewGrid.appendChild(previewItem);

          // æ›´æ–°æŒ‰é’®çŠ¶æ€
          startReadingBtn.disabled = false;
          savePhotoBtn.disabled = false;
        }, 'image/jpeg', 0.95);
      }

      // æ‰¹é‡ä¿å­˜æ‰€æœ‰ç…§ç‰‡
      const savePhotoBtn = document.getElementById('save-photo');
      savePhotoBtn.addEventListener('click', function() {
        if (capturedPhotos.length === 0) {
          alert('æ²¡æœ‰å¯ä¿å­˜çš„ç…§ç‰‡');
          return;
        }

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„zipæ–‡ä»¶
        const zip = new JSZip();
        const promises = [];

        capturedPhotos.forEach((file, index) => {
          const promise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              zip.file(file.name, e.target.result);
              resolve();
            };
            reader.readAsArrayBuffer(file);
          });
          promises.push(promise);
        });

        Promise.all(promises).then(() => {
          zip.generateAsync({type: 'blob'}).then((content) => {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `photos_${new Date().toISOString().slice(0,10)}.zip`;
            link.click();
          });
        });
      });

      // ç»‘å®šæ‘„åƒå¤´ç›¸å…³äº‹ä»¶
      startCameraBtn.addEventListener('click', startCamera);
      stopCameraBtn.addEventListener('click', stopCamera);
      capturePhotoBtn.addEventListener('click', capturePhoto);

      // åˆå§‹åŠ è½½è€ƒè¯•åœºæ¬¡
      loadExamSessions();
      // åˆå§‹ç¦ç”¨å¼€å§‹é˜…å·æŒ‰é’®
      startReadingBtn.disabled = true;
      
      console.log('DOMåŠ è½½å®Œæˆï¼Œæ‰€æœ‰å‡½æ•°å·²åˆå§‹åŒ–');
    });
  </script>
{% endblock %}