{% extends "base.html" %}

{% block content %}
  <div class="w-full max-w-4xl px-6">
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4">äººå·¥å¤æ ¸</h2>
      <p class="text-muted-foreground mb-6">å¤æ ¸ç³»ç»Ÿç”Ÿæˆçš„æˆç»©ï¼Œæ‰‹åŠ¨è°ƒæ•´å¹¶ç¡®è®¤æœ€ç»ˆæˆç»©ã€‚</p>
      
      <!-- è€ƒè¯•åœºæ¬¡é€‰æ‹©åŒºåŸŸ -->
      <div class="mb-8 space-y-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">é€‰æ‹©è€ƒè¯•åœºæ¬¡</h3>
          <div class="flex items-center space-x-3">
            <button id="mark-as-graded-btn" 
                    class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors duration-200"
                    style="display: none;">
              å®Œæˆè¯„åˆ†
            </button>
            <div class="relative">
              <select id="exam-session" 
                      class="bg-input text-foreground border border-border rounded-md px-4 py-2 pr-8 appearance-none cursor-pointer">
                <option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>
              </select>
              <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
            </div>
          </div>
        </div>

        <!-- å­¦ç”Ÿåˆ—è¡¨åŒºåŸŸ -->
        <div class="border border-border rounded-lg p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold">å­¦ç”Ÿåˆ—è¡¨</h3>
            <div class="flex items-center space-x-4">
              <div class="relative">
                <input type="text" 
                       id="student-search"
                       class="w-64 bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2"
                       placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·..." />
                <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
              </div>
              <button id="search-button"
                      class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
                æœç´¢
              </button>
            </div>
          </div>

          <!-- å­¦ç”Ÿåˆ—è¡¨ -->
          <div id="student-list" class="divide-y divide-border">
            <!-- å­¦ç”Ÿåˆ—è¡¨é¡¹ä¼šé€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
          </div>
        </div>
      </div>

      <!-- ç­”é¢˜è¯¦æƒ…åŒºåŸŸ -->
      <div id="answer-details" class="space-y-6" style="display: none;">
        <!-- å­¦ç”Ÿä¿¡æ¯å¤´éƒ¨ -->
        <div class="border border-border rounded-lg p-6">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
              <span class="text-2xl">ğŸ‘¨â€ğŸ“</span>
              <div>
                <h4 class="font-semibold student-name"></h4>
                <p class="text-sm text-muted-foreground student-id"></p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-right">
                <p class="text-sm text-muted-foreground">åˆæ­¥æˆç»©</p>
                <p class="font-semibold text-lg initial-score"></p>
              </div>
              <div class="border-l border-border pl-4">
                <button onclick="confirmAllScores()"
                        class="bg-primary text-primary-foreground px-6 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
                  ä¸€é”®å¤æ ¸
                </button>
              </div>
            </div>
          </div>

          <!-- è¯•å·å†…å®¹ -->
          <div class="space-y-6">
            <div class="bg-muted/30 px-4 py-3 border-b border-border">
              <h6 class="font-medium exam-name">2024å¹´æ˜¥å­£æœŸä¸­è€ƒè¯• - äººå·¥æ™ºèƒ½åŸºç¡€</h6>
            </div>
            
            <!-- ç­”é¢˜è¯¦æƒ…åˆ—è¡¨ -->
            <div id="questions-list" class="space-y-4">
              <!-- é¢˜ç›®è¯¦æƒ…ä¼šé€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åœ¨ content div ç»“æŸå‰æ·»åŠ  AI åŠ©æ‰‹èŠå¤©æ¡† -->
  <div id="ai-assistant" class="fixed right-0 bottom-0 w-80 transition-all duration-300 transform translate-x-full">
    <!-- èŠå¤©æ¡†ä¸»ä½“ -->
    <div class="border border-border rounded-tl-lg shadow-lg bg-card flex flex-col h-[500px]">
      <!-- èŠå¤©æ¡†å¤´éƒ¨ -->
      <div class="bg-primary text-primary-foreground p-3 rounded-tl-lg flex justify-between items-center">
        <h3 class="font-semibold">AI åŠ©æ‰‹</h3>
        <div class="flex space-x-2">
          <button id="ai-minimize" class="text-primary-foreground/80 hover:text-primary-foreground">
            â–¬
          </button>
          <button id="ai-close" class="text-primary-foreground/80 hover:text-primary-foreground">
            âœ•
          </button>
        </div>
      </div>
      
      <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
      <div id="ai-messages" class="flex-1 overflow-y-auto p-3 space-y-3">
        <div class="message ai-message">
          <div class="bg-muted/50 rounded-lg p-2 max-w-[90%] inline-block">
            æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨è§£æé¢˜ç›®ã€å­¦ç”Ÿç­”æ¡ˆå’Œè¯„åˆ†ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£å“ªé“é¢˜çš„ä¿¡æ¯ï¼Ÿ
          </div>
        </div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="border-t border-border p-3">
        <div class="flex space-x-2">
          <input id="ai-input" 
                 class="flex-1 bg-input text-foreground border border-border rounded-md px-3 py-2"
                 placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                 onkeypress="if(event.key === 'Enter') sendAiMessage()"/>
          <button id="ai-send" 
                  class="bg-primary text-primary-foreground px-3 py-2 rounded-md hover:bg-primary/80"
                  onclick="sendAiMessage()">
            å‘é€
          </button>
        </div>
      </div>
    </div>
    
    <!-- å±•å¼€æŒ‰é’® -->
    <button id="ai-toggle" 
            class="absolute top-1/2 -left-10 transform -translate-y-1/2 bg-primary text-primary-foreground h-20 w-10 rounded-l-md flex items-center justify-center">
      <span class="transform -rotate-90">AIåŠ©æ‰‹</span>
    </button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–åŠ è½½è€ƒè¯•åœºæ¬¡
      loadExamSessions();

      // æœç´¢å’Œæ’åºäº‹ä»¶ç›‘å¬
      const studentSearch = document.getElementById('student-search');
      const searchButton = document.getElementById('search-button');
      const examSession = document.getElementById('exam-session');
      const markAsGradedBtn = document.getElementById('mark-as-graded-btn');

      // æ·»åŠ å®Œæˆè¯„åˆ†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      markAsGradedBtn.addEventListener('click', function() {
        if (examSession.value) {
          markExamAsGraded(examSession.value);
        }
      });

      // æ·»åŠ æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      searchButton.addEventListener('click', function() {
        if (examSession.value) {
          loadStudents(examSession.value, studentSearch.value);
        }
      });

      // æ·»åŠ å›è½¦é”®æœç´¢
      studentSearch.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && examSession.value) {
          loadStudents(examSession.value, studentSearch.value);
        }
      });

      examSession.addEventListener('change', function() {
        if (this.value) {
          loadStudents(this.value);
          document.getElementById('answer-details').style.display = 'none';
          // æ˜¾ç¤ºå®Œæˆè¯„åˆ†æŒ‰é’®
          markAsGradedBtn.style.display = 'block';
        } else {
          markAsGradedBtn.style.display = 'none';
        }
      });

      // åˆå§‹åŒ–AIåŠ©æ‰‹ç›¸å…³äº‹ä»¶
      initAiAssistant();
    });

    // åŠ è½½è€ƒè¯•åœºæ¬¡
    async function loadExamSessions() {
      try {
        const response = await fetch('/api/review/sessions');
        const sessions = await response.json();
        
        const select = document.getElementById('exam-session');
        select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>';
        
        sessions.forEach(session => {
          const option = document.createElement('option');
          option.value = session.id;
          option.textContent = session.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥:', error);
      }
    }

    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    async function loadStudents(sessionId, search = '') {
      try {
        const url = new URL(`/api/review/students/${sessionId}`, window.location.origin);
        if (search) {
          url.searchParams.append('search', search);
        }

        console.log('Fetching URL:', url.toString());
        const response = await fetch(url);
        const students = await response.json();
        console.log('Received students:', students);

        const studentList = document.getElementById('student-list');
        studentList.innerHTML = '';

        if (students.length === 0) {
          studentList.innerHTML = `
            <div class="p-4 text-center text-muted-foreground">
              æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ
            </div>
          `;
          return;
        }

        students.forEach(student => {
          const div = document.createElement('div');
          div.className = 'student-item p-4 hover:bg-gray-100 cursor-pointer';
          div.dataset.studentId = student.id;
          div.innerHTML = `
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-3">
                <span class="text-xl">ğŸ‘¨â€ğŸ“</span>
                <div>
                  <p class="font-medium student-name">${student.name}</p>
                  <p class="text-sm text-gray-500 student-id">å­¦å·ï¼š${student.student_id}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-medium score">${student.initial_score}åˆ†</p>
                <p class="text-sm text-gray-500 status">
                  ${student.review_status === 'reviewed' ? 'å·²å¤æ ¸' : 'å¾…å¤æ ¸'}
                </p>
              </div>
            </div>
          `;

          div.addEventListener('click', () => {
            document.querySelectorAll('.student-item').forEach(item => {
              item.classList.remove('selected', 'bg-blue-50');
            });
            
            div.classList.add('selected', 'bg-blue-50');
            
            document.querySelector('#answer-details .student-name').textContent = student.name;
            document.querySelector('#answer-details .student-id').textContent = `å­¦å·ï¼š${student.student_id}`;
            document.querySelector('#answer-details .initial-score').textContent = `${student.initial_score}åˆ†`;
            
            loadAnswerDetails(sessionId, student.id);
            document.getElementById('answer-details').style.display = 'block';
          });

          studentList.appendChild(div);
        });
      } catch (error) {
        console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
        const studentList = document.getElementById('student-list');
        studentList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            åŠ è½½å¤±è´¥ï¼š${error.message}
          </div>
        `;
      }
    }

    // åŠ è½½ç­”é¢˜è¯¦æƒ…
    async function loadAnswerDetails(sessionId, studentId) {
      try {
        console.log('Loading answers for session:', sessionId, 'student:', studentId);
        const response = await fetch(`/api/review/answers/${sessionId}/${studentId}`);
        const answers = await response.json();
        console.log('Received answers:', answers);
        
        // æ›´æ–°å½“å‰é—®é¢˜æ•°æ®
        window.currentQuestionData.sessionId = sessionId;
        window.currentQuestionData.studentId = studentId;
        updateCurrentQuestionData(answers);
        
        // åŸæœ‰ä»£ç ä¸å˜
        const answerDetails = document.getElementById('answer-details');
        answerDetails.style.display = 'block';
        
        // æ›´æ–°ç­”é¢˜è¯¦æƒ…
        const questionsList = document.getElementById('questions-list');
        questionsList.innerHTML = '';
        
        if (!answers || answers.length === 0) {
          questionsList.innerHTML = `
            <div class="p-4 text-center text-muted-foreground">
              æš‚æ— ç­”é¢˜è®°å½•
            </div>
          `;
          return;
        }
        
        answers.forEach(answer => {
          const div = document.createElement('div');
          div.className = 'question-item border rounded-lg p-4 mb-4';
          div.dataset.questionId = answer.question_id;
          div.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <h4 class="font-medium">é¢˜ç›® ${answer.question_order}ï¼š${answer.question_text}</h4>
                <p class="text-sm text-gray-500">æ»¡åˆ†ï¼š${answer.total_score}åˆ†</p>
              </div>
              <div class="text-right">
                <p class="font-medium">AIè¯„åˆ†ï¼š${answer.ai_score}åˆ†</p>
                <p class="text-sm status ${answer.review_status === 'reviewed' ? 'text-green-500' : 'text-yellow-500'}">
                  ${answer.review_status === 'reviewed' ? 'å·²å¤æ ¸' : 'å¾…å¤æ ¸'}
                </p>
              </div>
            </div>
            
            <div class="space-y-3">
              <div class="bg-muted/30 rounded p-3">
                <p class="text-sm"><span class="font-medium">å­¦ç”Ÿç­”æ¡ˆï¼š</span>${answer.answer_text || 'æ— ç­”æ¡ˆ'}</p>
              </div>
              
              <div class="bg-muted/30 rounded p-3">
                <p class="text-sm"><span class="font-medium">AIåé¦ˆï¼š</span>${answer.ai_feedback || 'æ— '}</p>
              </div>
              
              ${answer.manual_feedback ? `
                <div class="bg-muted/30 rounded p-3">
                  <p class="text-sm"><span class="font-medium">äººå·¥åé¦ˆï¼š</span>${answer.manual_feedback}</p>
                </div>
              ` : ''}
              
              <div class="flex items-center space-x-4 mt-4">
                <input type="number" 
                       class="w-24 bg-input text-foreground border border-border rounded-md px-3 py-2" 
                       value="${answer.final_score || answer.ai_score}"
                       min="0"
                       max="${answer.total_score}"
                       onchange="updateTotalScore()"/>
                <button class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200"
                        onclick="submitReview(${sessionId}, ${studentId}, ${answer.question_id}, this.previousElementSibling.value)">
                  ç¡®è®¤ä¿®æ”¹
                </button>
              </div>
            </div>
          `;
          
          questionsList.appendChild(div);
        });
      } catch (error) {
        console.error('åŠ è½½ç­”é¢˜è¯¦æƒ…å¤±è´¥:', error);
        const questionsList = document.getElementById('questions-list');
        questionsList.innerHTML = `
          <div class="p-4 text-center text-red-500">
            åŠ è½½ç­”é¢˜è¯¦æƒ…å¤±è´¥ï¼š${error.message}
          </div>
        `;
      }
    }

    // æäº¤å¤æ ¸ç»“æœ
    async function submitReview(sessionId, studentId, questionId, finalScore) {
      try {
        const response = await fetch('/api/review/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            student_id: studentId,
            question_id: questionId,
            final_score: parseInt(finalScore)
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-lg';
          notification.textContent = 'ä¿å­˜æˆåŠŸï¼';
          document.body.appendChild(notification);
          
          // 3ç§’åç§»é™¤æç¤º
          setTimeout(() => {
            notification.remove();
          }, 3000);
          
          // é‡æ–°è®¡ç®—æ€»åˆ†å¹¶æ›´æ–°æ˜¾ç¤º
          const questionsList = document.getElementById('questions-list');
          const allScoreInputs = questionsList.querySelectorAll('input[type="number"]');
          let totalScore = 0;
          allScoreInputs.forEach(input => {
            totalScore += parseInt(input.value) || 0;
          });
          
          // æ›´æ–°åˆæ­¥æˆç»©æ˜¾ç¤º
          document.querySelector('.initial-score').textContent = `${totalScore}åˆ†`;
          
          // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨ä¸­çš„åˆ†æ•°
          const studentItem = document.querySelector(`.student-item[data-student-id="${studentId}"]`);
          if (studentItem) {
            const scoreElement = studentItem.querySelector('.text-right .font-medium');
            if (scoreElement) {
              scoreElement.textContent = `${totalScore}åˆ†`;
            }
            // æ›´æ–°å¤æ ¸çŠ¶æ€
            const statusElement = studentItem.querySelector('.text-right .text-muted-foreground');
            if (statusElement) {
              statusElement.textContent = 'å·²å¤æ ¸';
            }
          }
          
          // æ›´æ–°é¢˜ç›®çš„å¤æ ¸çŠ¶æ€
          const questionDiv = document.querySelector(`[data-question-id="${questionId}"]`);
          if (questionDiv) {
            const statusElement = questionDiv.querySelector('.text-yellow-500, .text-green-500');
            if (statusElement) {
              statusElement.className = 'text-sm text-green-500';
              statusElement.textContent = 'å·²å¤æ ¸';
            }
          }
        } else {
          throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        console.error('æäº¤å¤æ ¸ç»“æœå¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    }

    // æ·»åŠ å®æ—¶è®¡ç®—æ€»åˆ†çš„å‡½æ•°
    function updateTotalScore() {
      const questionsList = document.getElementById('questions-list');
      const allScoreInputs = questionsList.querySelectorAll('input[type="number"]');
      let totalScore = 0;
      allScoreInputs.forEach(input => {
        totalScore += parseInt(input.value) || 0;
      });
      document.querySelector('.initial-score').textContent = `${totalScore}åˆ†`;
    }

    // æ·»åŠ ä¸€é”®å¤æ ¸å‡½æ•°
    async function confirmAllScores() {
      try {
        const sessionId = document.getElementById('exam-session').value;
        const selectedStudent = document.querySelector('.student-item.selected');
        if (!selectedStudent) {
          alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
          return;
        }
        
        const studentId = selectedStudent.dataset.studentId;
        const questionsList = document.getElementById('questions-list');
        const allQuestions = questionsList.querySelectorAll('.question-item');
        
        // æ”¶é›†æ‰€æœ‰é¢˜ç›®çš„åˆ†æ•°
        const scores = [];
        allQuestions.forEach(question => {
          const questionId = question.dataset.questionId;
          const scoreInput = question.querySelector('input[type="number"]');
          if (scoreInput && questionId) {
            scores.push({
              question_id: parseInt(questionId),
              final_score: parseInt(scoreInput.value) || 0
            });
          }
        });
        
        if (scores.length === 0) {
          alert('æœªæ‰¾åˆ°ä»»ä½•é¢˜ç›®');
          return;
        }

        // å‘é€æ‰¹é‡å¤æ ¸è¯·æ±‚
        const response = await fetch('/api/review/submit-all', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: parseInt(sessionId),
            student_id: parseInt(studentId),
            scores: scores
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-lg';
          notification.textContent = 'ä¸€é”®å¤æ ¸æˆåŠŸï¼';
          document.body.appendChild(notification);
          
          setTimeout(() => notification.remove(), 3000);
          
          // æ›´æ–°æ‰€æœ‰é¢˜ç›®çš„çŠ¶æ€
          allQuestions.forEach(question => {
            const statusElement = question.querySelector('.status');
            if (statusElement) {
              statusElement.textContent = 'å·²å¤æ ¸';
              statusElement.className = 'text-sm text-green-500 status';
            }
          });
          
          // æ›´æ–°å­¦ç”Ÿåˆ—è¡¨ä¸­çš„çŠ¶æ€
          const statusElement = selectedStudent.querySelector('.status');
          if (statusElement) {
            statusElement.textContent = 'å·²å¤æ ¸';
          }
        } else {
          throw new Error(result.error || 'ä¸€é”®å¤æ ¸å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¸€é”®å¤æ ¸å¤±è´¥:', error);
        alert('ä¸€é”®å¤æ ¸å¤±è´¥ï¼š' + error.message);
      }
    }

    // åˆå§‹åŒ–AIåŠ©æ‰‹
    function initAiAssistant() {
      const aiAssistant = document.getElementById('ai-assistant');
      const aiToggle = document.getElementById('ai-toggle');
      const aiClose = document.getElementById('ai-close');
      const aiMinimize = document.getElementById('ai-minimize');
      
      // å­˜å‚¨å½“å‰é€‰ä¸­çš„é¢˜ç›®å’Œå­¦ç”Ÿä¿¡æ¯
      window.currentQuestionData = {
        sessionId: null,
        studentId: null,
        questions: []
      };
      
      // åˆ‡æ¢æ˜¾ç¤º/éšè—
      aiToggle.addEventListener('click', function() {
        if (aiAssistant.classList.contains('translate-x-full')) {
          aiAssistant.classList.remove('translate-x-full');
          aiAssistant.classList.add('translate-x-0');
        } else {
          aiAssistant.classList.remove('translate-x-0');
          aiAssistant.classList.add('translate-x-full');
        }
      });
      
      // å…³é—­æŒ‰é’®
      aiClose.addEventListener('click', function() {
        aiAssistant.classList.remove('translate-x-0');
        aiAssistant.classList.add('translate-x-full');
      });
      
      // æœ€å°åŒ–æŒ‰é’®
      aiMinimize.addEventListener('click', function() {
        aiAssistant.classList.remove('translate-x-0');
        aiAssistant.classList.add('translate-x-full');
      });
    }
    
    // æ›´æ–°å­˜å‚¨çš„é¢˜ç›®æ•°æ®
    function updateCurrentQuestionData(answers) {
      window.currentQuestionData.questions = answers.map(answer => ({
        order: answer.question_order,
        id: answer.question_id,
        text: answer.question_text,
        studentAnswer: answer.answer_text || 'æ— ç­”æ¡ˆ',
        aiScore: answer.ai_score,
        totalScore: answer.total_score,
        aiFeedback: answer.ai_feedback || 'æ— ',
        manualFeedback: answer.manual_feedback || ''
      }));
    }

    // å‘é€æ¶ˆæ¯ç»™AI
    async function sendAiMessage() {
      const input = document.getElementById('ai-input');
      const message = input.value.trim();
      
      if (!message) return;
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      input.value = '';
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©æ¡†
      addUserMessage(message);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åŠ è½½é¢˜ç›®
      if (!window.currentQuestionData.questions.length) {
        addAiMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­¦ç”Ÿå’Œè€ƒè¯•ï¼Œä»¥ä¾¿æˆ‘è·å–é¢˜ç›®ä¿¡æ¯ã€‚');
        return;
      }
      
      // æ·»åŠ æ­£åœ¨è¾“å…¥æç¤º
      const typingIndicator = addTypingIndicator();
      
      try {
        // åˆ†æç”¨æˆ·é—®é¢˜ï¼Œæ‰¾å‡ºç›¸å…³é¢˜ç›®
        const questionData = findRelevantQuestionData(message);
        
        // è°ƒç”¨APIè·å–AIå›ç­”
        const response = await fetch('/api/agent/review-assistant', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            user_message: message,
            session_id: window.currentQuestionData.sessionId,
            student_id: window.currentQuestionData.studentId,
            question_data: questionData || window.currentQuestionData.questions
          })
        });
        
        // ç§»é™¤åŠ è½½æç¤º
        typingIndicator.remove();
        
        if (response.ok) {
          const result = await response.json();
          addAiMessage(result.response);
        } else {
          throw new Error('è·å–AIå›å¤å¤±è´¥');
        }
      } catch (error) {
        console.error('AIåŠ©æ‰‹é”™è¯¯:', error);
        
        // ç§»é™¤åŠ è½½æç¤º
        typingIndicator.remove();
        
        // æ·»åŠ é”™è¯¯æ¶ˆæ¯
        addAiMessage('æŠ±æ­‰ï¼Œæ— æ³•è·å–å›ç­”ã€‚è¯·ç¨åå†è¯•ã€‚');
      }
    }
    
    // æ ¹æ®ç”¨æˆ·é—®é¢˜æŸ¥æ‰¾ç›¸å…³é¢˜ç›®
    function findRelevantQuestionData(message) {
      // å¦‚æœæåˆ°äº†ç‰¹å®šé¢˜å·
      const questionNumberMatch = message.match(/ç¬¬\s*(\d+)\s*é¢˜/);
      if (questionNumberMatch) {
        const questionOrder = parseInt(questionNumberMatch[1]);
        const questionData = window.currentQuestionData.questions.find(q => q.order === questionOrder);
        if (questionData) {
          return [questionData];
        }
      }
      
      // å¦‚æœè¯´"è¿™é“é¢˜"ï¼Œåˆ™è¿”å›å½“å‰é€‰ä¸­çš„é¢˜ç›®
      if (message.includes('è¿™é“é¢˜') || message.includes('è¿™ä¸ªé¢˜') || message.includes('è¿™é¢˜')) {
        // è·å–å½“å‰å¯è§çš„é¢˜ç›®ä¿¡æ¯
        const visibleQuestionElements = document.querySelectorAll('.question-item');
        if (visibleQuestionElements.length > 0) {
          // å‡è®¾ç”¨æˆ·æ­£åœ¨çœ‹çš„æ˜¯é¡µé¢ä¸Šæœ€ä¸Šæ–¹çš„é¢˜ç›®
          const firstVisibleQuestionId = parseInt(visibleQuestionElements[0].dataset.questionId);
          const questionData = window.currentQuestionData.questions.find(q => q.id === firstVisibleQuestionId);
          if (questionData) {
            return [questionData];
          }
        }
      }
      
      // é»˜è®¤è¿”å›æ‰€æœ‰é¢˜ç›®
      return window.currentQuestionData.questions;
    }
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©æ¡†
    function addUserMessage(text) {
      const messagesContainer = document.getElementById('ai-messages');
      const messageElement = document.createElement('div');
      messageElement.className = 'message user-message text-right';
      messageElement.innerHTML = `
        <div class="bg-primary text-primary-foreground rounded-lg p-2 max-w-[90%] inline-block">
          ${text}
        </div>
      `;
      messagesContainer.appendChild(messageElement);
      scrollToBottom(messagesContainer);
    }
    
    // æ·»åŠ AIæ¶ˆæ¯åˆ°èŠå¤©æ¡†
    function addAiMessage(text) {
      const messagesContainer = document.getElementById('ai-messages');
      const messageElement = document.createElement('div');
      messageElement.className = 'message ai-message';
      messageElement.innerHTML = `
        <div class="bg-muted/50 rounded-lg p-2 max-w-[90%] inline-block">
          ${text}
        </div>
      `;
      messagesContainer.appendChild(messageElement);
      scrollToBottom(messagesContainer);
    }
    
    // æ·»åŠ "æ­£åœ¨è¾“å…¥"æç¤º
    function addTypingIndicator() {
      const messagesContainer = document.getElementById('ai-messages');
      const typingElement = document.createElement('div');
      typingElement.className = 'message ai-message typing-indicator';
      typingElement.innerHTML = `
        <div class="bg-muted/50 rounded-lg p-2 max-w-[90%] inline-block">
          <span class="dot-typing">...</span>
        </div>
      `;
      messagesContainer.appendChild(typingElement);
      scrollToBottom(messagesContainer);
      return typingElement;
    }
    
    // æ»šåŠ¨åˆ°èŠå¤©æ¡†åº•éƒ¨
    function scrollToBottom(element) {
      element.scrollTop = element.scrollHeight;
    }

    // å°†è€ƒè¯•æ ‡è®°ä¸ºå·²è¯„åˆ†
    async function markExamAsGraded(sessionId) {
      try {
        if (!confirm('ç¡®å®šå°†æ­¤è€ƒè¯•æ ‡è®°ä¸ºå·²è¯„åˆ†ï¼Ÿè¿™å°†ç”Ÿæˆæœ€ç»ˆçš„ç»Ÿè®¡æ•°æ®ã€‚')) {
          return;
        }
        
        const response = await fetch('/api/review/mark-as-graded', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: parseInt(sessionId)
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-md shadow-lg';
          notification.textContent = 'è€ƒè¯•å·²æ ‡è®°ä¸ºå·²è¯„åˆ†ï¼Œç»Ÿè®¡æ•°æ®å·²æ›´æ–°ï¼';
          document.body.appendChild(notification);
          
          setTimeout(() => notification.remove(), 3000);
        } else {
          throw new Error(result.error || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error('æ ‡è®°ä¸ºå·²è¯„åˆ†å¤±è´¥:', error);
        alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
      }
    }
  </script>

  <style>
    /* ä¸ºAIåŠ©æ‰‹æ·»åŠ æ ·å¼ */
    .dot-typing {
      position: relative;
      animation: dotTyping 1.5s infinite linear;
    }
    
    @keyframes dotTyping {
      0% { content: 'Â·'; }
      25% { content: 'Â·Â·'; }
      50% { content: 'Â·Â·Â·'; }
      75% { content: 'Â·Â·Â·Â·'; }
      100% { content: 'Â·'; }
    }
    
    #ai-assistant {
      z-index: 1000;
    }
    
    #ai-messages::-webkit-scrollbar {
      width: 5px;
    }
    
    #ai-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
  </style>
{% endblock %}
