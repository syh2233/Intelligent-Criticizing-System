{% extends "base.html" %}

<!-- åœ¨ head éƒ¨åˆ†æ·»åŠ  Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">æˆç»©åˆ†æ</h2>
    <p class="text-muted-foreground mb-6">æŸ¥çœ‹æˆç»©ç»Ÿè®¡æ•°æ®å¹¶å¯¼å‡ºåˆ†ææŠ¥å‘Šã€‚</p>

    <!-- è€ƒè¯•åœºæ¬¡é€‰æ‹© -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">é€‰æ‹©è€ƒè¯•åœºæ¬¡</h3>
        <div class="relative">
          <select id="exam-session" 
                  class="bg-input text-foreground border border-border rounded-md px-4 py-2 pr-8 appearance-none cursor-pointer">
            <option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>
          </select>
          <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
        </div>
      </div>
    </div>

    <!-- æˆç»©æ¦‚è§ˆå¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="average-score">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">å¹³å‡åˆ†</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="pass-rate">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">åŠæ ¼ç‡</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="highest-score">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">æœ€é«˜åˆ†</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
    </div>

    <!-- è€ƒè¯•ä¿¡æ¯ -->
    <div class="border border-border rounded-lg p-4 mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold">è€ƒè¯•ä¿¡æ¯</h4>
          <p class="text-sm text-muted-foreground mt-1">æ€»äººæ•°ï¼š<span id="total-students">-</span></p>
        </div>
        <div class="text-right">
          <p class="text-sm text-muted-foreground">æœªè¯„åˆ†äººæ•°ï¼š<span id="ungraded-count" class="font-medium text-warning">-</span></p>
        </div>
      </div>
    </div>

    <!-- åˆ†æ•°åˆ†å¸ƒå›¾è¡¨ -->
    <div class="border border-border rounded-lg p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">åˆ†æ•°åˆ†å¸ƒ</h3>
      <div class="h-64 relative">
        <canvas id="score-distribution-chart"></canvas>
      </div>
    </div>

    <!-- é¢˜ç›®åˆ†æ -->
    <div class="border border-border rounded-lg p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">é¢˜ç›®åˆ†æ</h3>
      <div class="question-analysis-container space-y-4">
        <!-- é¢˜ç›®åˆ†æå†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
      </div>
    </div>

    <!-- è€ƒç”Ÿå†å²æˆç»©åˆ†æ -->
    <div class="border border-border rounded-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold">è€ƒç”Ÿå†å²æˆç»©åˆ†æ</h3>
            <div class="flex items-center space-x-4">
                <!-- å­¦ç”Ÿæœç´¢ -->
                <div class="relative">
                    <form id="student-search-form" class="relative" onsubmit="return false;">
                        <input type="text" 
                               id="student-search"
                               class="w-64 bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2"
                               placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·..."
                               autocomplete="off" />
                        <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
                    </form>
                </div>
                <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
                <select id="time-range" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
                    <option value="1year">æœ€è¿‘ä¸€å¹´</option>
                    <option value="2years">æœ€è¿‘ä¸¤å¹´</option>
                    <option value="all">å…¨éƒ¨è®°å½•</option>
                </select>
            </div>
        </div>

        <!-- é€‰ä¸­çš„å­¦ç”Ÿä¿¡æ¯ -->
        <div id="selected-student" class="mb-6 p-4 bg-muted/30 rounded-lg" style="display: none;">
            <div class="flex items-center space-x-4 mb-4">
                <span class="text-2xl">ğŸ‘¨â€ğŸ“</span>
                <div>
                    <h4 class="font-semibold"></h4>
                    <p class="text-sm text-muted-foreground"></p>
                </div>
            </div>
            
            <!-- æˆç»©è¶‹åŠ¿å›¾ -->
            <div class="mb-6">
                <h5 class="font-medium mb-3">æˆç»©è¶‹åŠ¿</h5>
                <div class="h-48 bg-muted/30 rounded-lg">
                    <canvas id="score-trend-chart"></canvas>
                </div>
            </div>

            <!-- å†å²è€ƒè¯•è®°å½•è¡¨æ ¼ -->
            <div>
                <h5 class="font-medium mb-3">å†å²è€ƒè¯•è®°å½•</h5>
                <div class="overflow-x-auto">
                    <table class="w-full history-table">
                        <thead class="bg-muted/30">
                            <tr>
                                <th class="px-4 py-2 text-left">è€ƒè¯•åç§°</th>
                                <th class="px-4 py-2 text-left">è€ƒè¯•æ—¶é—´</th>
                                <th class="px-4 py-2 text-left">å¾—åˆ†</th>
                                <th class="px-4 py-2 text-left">ç­çº§æ’å</th>
                                <th class="px-4 py-2 text-left">ä¸å¹³å‡åˆ†å·®</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æˆç»©åˆ†ææŠ¥å‘Š -->
            <div class="mt-6 space-y-4">
                <h5 class="font-medium">æˆç»©åˆ†ææŠ¥å‘Š</h5>
                <div class="space-y-2">
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ“ˆ</span>
                        <p class="text-sm text-muted-foreground">æˆç»©æ•´ä½“å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œè¿‘ä¸‰æ¬¡è€ƒè¯•å¹³å‡æå‡3.5åˆ†</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ¯</span>
                        <p class="text-sm text-muted-foreground">ä¼˜åŠ¿ç§‘ç›®ï¼šäººå·¥æ™ºèƒ½åŸºç¡€ï¼Œè¿‘æœŸè€ƒè¯•å¹³å‡åˆ†95åˆ†ä»¥ä¸Š</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ’¡</span>
                        <p class="text-sm text-muted-foreground">å»ºè®®ï¼šå¯ä»¥åœ¨å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†ææ–¹é¢ç»§ç»­åŠ å¼º</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯¼å‡ºé€‰é¡¹éƒ¨åˆ† -->
    <div class="border border-border rounded-lg p-6">
      <h3 class="text-lg font-semibold mb-4">å¯¼å‡ºé€‰é¡¹</h3>
      <div class="space-y-6">
        <!-- å¯¼å‡ºç±»å‹é€‰æ‹© -->
        <div class="flex items-center space-x-6">
          <label class="flex items-center space-x-2">
            <input type="radio" 
                   name="export-type" 
                   value="exam" 
                   class="w-4 h-4 text-primary border-border focus:ring-primary"
                   checked>
            <span>è€ƒè¯•åœºæ¬¡åˆ†æ</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="radio" 
                   name="export-type" 
                   value="student" 
                   class="w-4 h-4 text-primary border-border focus:ring-primary">
            <span>å­¦ç”Ÿæˆç»©åˆ†æ</span>
          </label>
        </div>

        <!-- è€ƒè¯•åœºæ¬¡åˆ†æå¯¼å‡ºé€‰é¡¹ -->
        <div id="exam-export-options" class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">æ•´ä½“åˆ†ææŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«åˆ†æ•°åˆ†å¸ƒã€å¹³å‡åˆ†ã€åŠæ ¼ç‡ç­‰ç»Ÿè®¡æ•°æ®</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="analysis">
              <span>ğŸ“Š</span>
              <span>å¯¼å‡ºåˆ†ææŠ¥å‘Š</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">é¢˜ç›®åˆ†ææŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«å„é¢˜ç›®çš„éš¾åº¦ç³»æ•°ã€åŒºåˆ†åº¦ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="questions">
              <span>ğŸ“</span>
              <span>å¯¼å‡ºé¢˜ç›®åˆ†æ</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">æˆç»©æ±‡æ€»è¡¨</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©å’Œæ’åä¿¡æ¯</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="scores">
              <span>ğŸ“‘</span>
              <span>å¯¼å‡ºæˆç»©å•</span>
            </button>
          </div>
        </div>

        <!-- å­¦ç”Ÿæˆç»©åˆ†æå¯¼å‡ºé€‰é¡¹ -->
        <div id="student-export-options" class="space-y-4 hidden">
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">ä¸ªäººæˆç»©æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«å†å²æˆç»©è¶‹åŠ¿ã€æ’åå˜åŒ–ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="personal">
              <span>ğŸ“ˆ</span>
              <span>å¯¼å‡ºæˆç»©æŠ¥å‘Š</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">èƒ½åŠ›è¯Šæ–­æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«ä¼˜åŠ¿é¢˜å‹ã€è–„å¼±ç¯èŠ‚ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="ability">
              <span>ğŸ¯</span>
              <span>å¯¼å‡ºèƒ½åŠ›è¯Šæ–­</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">è¿›æ­¥å»ºè®®æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«é’ˆå¯¹æ€§çš„å­¦ä¹ å»ºè®®å’Œæ”¹è¿›æ–¹å‘</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="improvement">
              <span>ğŸ’¡</span>
              <span>å¯¼å‡ºå­¦ä¹ å»ºè®®</span>
            </button>
          </div>
        </div>

        <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹© -->
        <div class="flex items-center justify-between pt-4 border-t border-border">
          <div class="space-x-2">
            <span class="text-sm text-muted-foreground">å¯¼å‡ºæ ¼å¼ï¼š</span>
            <select id="export-format" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
              <option value="pdf">PDFæ ¼å¼</option>
              <option value="excel">Excelæ ¼å¼</option>
              <option value="word">Wordæ ¼å¼</option>
            </select>
          </div>
          <div class="text-sm text-muted-foreground">
            ä¸Šæ¬¡å¯¼å‡ºæ—¶é—´ï¼š<span id="last-export-time">2024-03-15 14:30</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ç¡®ä¿ Chart.js åŠ è½½
if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = function() {
        console.log('Chart.js åŠ è½½æˆåŠŸ');
        initializeCharts();
    };
    script.onerror = function() {
        console.error('Chart.js åŠ è½½å¤±è´¥');
    };
    document.head.appendChild(script);
} else {
    initializeCharts();
}

// åœ¨å…¨å±€ä½œç”¨åŸŸæ·»åŠ å˜é‡
let trendChart = null;

// å¯¼å‡ºç›¸å…³çš„å˜é‡
let selectedExportType = 'exam';
let selectedFormat = 'pdf';
let lastExportTime = null;

// å°†æ‰€æœ‰å›¾è¡¨ç›¸å…³çš„ä»£ç ç§»åˆ°è¿™ä¸ªå‡½æ•°ä¸­
function initializeCharts() {
    const examSession = document.getElementById('exam-session');
    const studentSearch = document.getElementById('student-search');
    let distributionChart = null;

    // ç»˜åˆ¶åˆ†æ•°åˆ†å¸ƒå›¾è¡¨
    function drawDistributionChart(distribution) {
        const canvas = document.getElementById('score-distribution-chart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ°å›¾è¡¨canvaså…ƒç´ ');
            return;
        }

        // å¦‚æœå·²å­˜åœ¨å›¾è¡¨ï¼Œå…ˆé”€æ¯å®ƒ
        if (distributionChart) {
            distributionChart.destroy();
        }

        // å‡†å¤‡æ•°æ®
        const data = {
            labels: distribution.map(d => d.range),
            datasets: [{
                label: 'å·²è¯„åˆ†äººæ•°',
                data: distribution.map(d => d.count - d.ungraded),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'æœªè¯„åˆ†äººæ•°',
                data: distribution.map(d => d.ungraded),
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                stack: 'Stack 0'
            }]
        };

        // é…ç½®é€‰é¡¹
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    stacked: true
                },
                x: {
                    stacked: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        };

        try {
            // åˆ›å»ºæ–°å›¾è¡¨
            distributionChart = new Chart(canvas, {
                type: 'bar',
                data: data,
                options: options
            });
            console.log('å›¾è¡¨åˆ›å»ºæˆåŠŸ');
        } catch (error) {
            console.error('åˆ›å»ºå›¾è¡¨å¤±è´¥:', error);
        }
    }

    // åŠ è½½è€ƒè¯•åœºæ¬¡åˆ—è¡¨
    function loadExamSessions() {
        console.log('å¼€å§‹åŠ è½½è€ƒè¯•åœºæ¬¡åˆ—è¡¨');
        fetch('/api/analysis/sessions')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(sessions => {
                console.log('è·å–åˆ°çš„è€ƒè¯•åœºæ¬¡æ•°æ®:', sessions);
                examSession.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>';
                if (sessions && sessions.length > 0) {
                    sessions.forEach(session => {
                        const startTime = new Date(session.start_time).toLocaleDateString();
                        examSession.innerHTML += `
                            <option value="${session.id}">
                                ${session.name} (${startTime})
                            </option>
                        `;
                    });
                } else {
                    examSession.innerHTML = '<option value="" disabled selected>æš‚æ— å¯åˆ†æçš„è€ƒè¯•åœºæ¬¡</option>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥:', error);
                examSession.innerHTML = '<option value="" disabled selected>åŠ è½½è€ƒè¯•åœºæ¬¡å¤±è´¥</option>';
            });
    }

    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        const examSession = document.getElementById('exam-session');
        loadExamSessions();  // åŠ è½½è€ƒè¯•åœºæ¬¡

        // ç›‘å¬è€ƒè¯•åœºæ¬¡é€‰æ‹©
        examSession.addEventListener('change', function(e) {
            const sessionId = e.target.value;
            if (!sessionId) return;
            console.log('é€‰æ‹©è€ƒè¯•åœºæ¬¡:', sessionId);

            // åŠ è½½åŸºæœ¬ç»Ÿè®¡æ•°æ®
            loadBasicStats(sessionId);
            
            // åŠ è½½åˆ†æ•°åˆ†å¸ƒæ•°æ®
            loadScoreDistribution(sessionId);
            
            // åŠ è½½é¢˜ç›®åˆ†ææ•°æ®
            loadQuestionAnalysis(sessionId);
        });
    });

    // åŠ è½½åŸºæœ¬ç»Ÿè®¡æ•°æ®
    function loadBasicStats(sessionId) {
        fetch(`/api/analysis/basic-stats/${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(stats => {
                console.log('è·å–åˆ°çš„ç»Ÿè®¡æ•°æ®:', stats);
                updateBasicStats(stats);
            })
            .catch(error => {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            });
    }

    // æ›´æ–°åŸºæœ¬ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
    function updateBasicStats(stats) {
        // æ›´æ–°å¹³å‡åˆ†
        const avgScoreEl = document.querySelector('[data-stat="average-score"]');
        if (avgScoreEl) {
            avgScoreEl.querySelector('.text-2xl').textContent = stats.average_score;
            avgScoreEl.querySelector('.text-sm').textContent = 
                `è¾ƒä¸Šæ¬¡${stats.average_score_change >= 0 ? 'æå‡' : 'ä¸‹é™'} ${Math.abs(stats.average_score_change)} åˆ†`;
        }
        
        // æ›´æ–°åŠæ ¼ç‡
        const passRateEl = document.querySelector('[data-stat="pass-rate"]');
        if (passRateEl) {
            passRateEl.querySelector('.text-2xl').textContent = `${stats.pass_rate}%`;
            passRateEl.querySelector('.text-sm').textContent = 
                `è¾ƒä¸Šæ¬¡${stats.pass_rate_change >= 0 ? 'æå‡' : 'ä¸‹é™'} ${Math.abs(stats.pass_rate_change)}%`;
        }
        
        // æ›´æ–°æœ€é«˜åˆ†
        const highestScoreEl = document.querySelector('[data-stat="highest-score"]');
        if (highestScoreEl) {
            highestScoreEl.querySelector('.text-2xl').textContent = stats.highest_score;
            highestScoreEl.querySelector('.text-sm').textContent = 
                `${stats.highest_score_student.name}ï¼ˆ${stats.highest_score_student.student_id}ï¼‰`;
        }

        // æ›´æ–°è€ƒè¯•ä¿¡æ¯
        const totalStudentsEl = document.getElementById('total-students');
        if (totalStudentsEl) {
            totalStudentsEl.textContent = stats.total_students;
        }

        const ungradedCountEl = document.getElementById('ungraded-count');
        if (ungradedCountEl) {
            ungradedCountEl.textContent = stats.ungraded_count;
            if (stats.ungraded_count > 0) {
                ungradedCountEl.classList.add('text-warning');
            } else {
                ungradedCountEl.classList.remove('text-warning');
            }
        }
    }

    // åŠ è½½åˆ†æ•°åˆ†å¸ƒæ•°æ®
    function loadScoreDistribution(sessionId) {
        fetch(`/api/analysis/score-distribution/${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(distribution => {
                console.log('è·å–åˆ°çš„åˆ†å¸ƒæ•°æ®:', distribution);
                drawDistributionChart(distribution);
            })
            .catch(error => {
                console.error('åŠ è½½åˆ†æ•°åˆ†å¸ƒæ•°æ®å¤±è´¥:', error);
            });
    }

    // åŠ è½½é¢˜ç›®åˆ†ææ•°æ®
    function loadQuestionAnalysis(sessionId) {
        fetch(`/api/analysis/question-analysis/${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(analysis => {
                console.log('è·å–åˆ°çš„é¢˜ç›®åˆ†ææ•°æ®:', analysis);
                updateQuestionAnalysis(analysis);
            })
            .catch(error => {
                console.error('åŠ è½½é¢˜ç›®åˆ†ææ•°æ®å¤±è´¥:', error);
            });
    }

    // æ›´æ–°é¢˜ç›®åˆ†ææ˜¾ç¤º
    function updateQuestionAnalysis(analysis) {
        const container = document.querySelector('.question-analysis-container');
        if (container) {
            container.innerHTML = analysis.map(q => `
                <div class="flex items-center justify-between p-3 bg-muted/30 rounded-lg">
                    <div>
                        <p class="font-medium">${q.question}</p>
                        <p class="text-sm text-muted-foreground">å¹³å‡å¾—åˆ†ç‡ï¼š${(q.average_score_rate * 100).toFixed(1)}%</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium">éš¾åº¦ç³»æ•°ï¼š${q.difficulty.toFixed(2)}</p>
                        <p class="text-sm text-muted-foreground">åŒºåˆ†åº¦ï¼š${q.discrimination.toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
        }
    }

    // åˆå§‹åŒ–å­¦ç”Ÿæœç´¢åŠŸèƒ½
    function initializeStudentSearch() {
        console.log('åˆå§‹åŒ–å­¦ç”Ÿæœç´¢åŠŸèƒ½');
        
        const searchForm = document.getElementById('student-search-form');
        const searchInput = document.getElementById('student-search');
        const timeRange = document.getElementById('time-range');
        
        // å¤„ç†æœç´¢
        async function handleSearch(searchTerm) {
            try {
                console.log('æœç´¢å­¦ç”Ÿ:', searchTerm);
                const response = await fetch(`/api/analysis/student-history/${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                console.log('æœç´¢ç»“æœ:', data); // è°ƒè¯•æ—¥å¿—
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                if (!data.student) {
                    showError('æœªæ‰¾åˆ°åŒ¹é…çš„å­¦ç”Ÿ');
                    return;
                }
                
                // æ›´æ–°å­¦ç”Ÿä¿¡æ¯æ˜¾ç¤º
                const studentInfo = document.querySelector('#selected-student');
                if (studentInfo) {
                    studentInfo.style.display = 'block';
                    studentInfo.dataset.studentId = data.student.id;
                    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                    const nameElement = studentInfo.querySelector('h4');
                    const idElement = studentInfo.querySelector('p');
                    if (nameElement && idElement) {
                        nameElement.textContent = data.student.name;
                        idElement.textContent = `å­¦å·ï¼š${data.student.student_id}`;
                    }
                }
                
                // æ›´æ–°å†å²è€ƒè¯•è®°å½•
                if (data.history && data.history.length > 0) {
                    // å…ˆæ›´æ–°è¡¨æ ¼
                    updateHistoryTable(data.history);
                    
                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿ DOM æ›´æ–°å®Œæˆ
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    // æ›´æ–°è¶‹åŠ¿å›¾
                    await updateScoreTrendChart(data.history);
                } else {
                    const tbody = document.querySelector('.history-table tbody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-4 py-2 text-center text-muted-foreground">
                                    æš‚æ— è€ƒè¯•è®°å½•
                                </td>
                            </tr>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // ç›‘å¬æœç´¢è¾“å…¥
        let searchTimeout;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value.trim();
            
            if (searchTerm.length >= 2) {
                searchTimeout = setTimeout(() => {
                    handleSearch(searchTerm);
                }, 300);
            }
        });
        
        // ç›‘å¬è¡¨å•æäº¤
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length >= 2) {
                handleSearch(searchTerm);
            }
        });
        
        // ç›‘å¬æ—¶é—´èŒƒå›´å˜åŒ–
        timeRange.addEventListener('change', function() {
            const studentInfo = document.querySelector('#selected-student');
            if (studentInfo.style.display !== 'none') {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    handleSearch(searchTerm);
                }
            }
        });
    }

    // ç¡®ä¿åœ¨ DOM åŠ è½½å®Œæˆååˆå§‹åŒ–æœç´¢åŠŸèƒ½
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeStudentSearch);
    } else {
        initializeStudentSearch();
    }

    // ç¡®ä¿åœ¨åˆ›å»ºæ–°å›¾è¡¨å‰é”€æ¯æ—§å›¾è¡¨
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }

    // åˆå§‹åŒ–è¶‹åŠ¿å›¾çš„é…ç½®
    const ctx = document.getElementById('score-trend-chart');
    if (ctx) {
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'è€ƒè¯•æˆç»©',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    }
}

// ä¿®æ”¹ updateScoreTrendChart å‡½æ•°
async function updateScoreTrendChart(history) {
    try {
        // ç¡®ä¿ Chart.js å·²åŠ è½½
        await loadChartJS();
        
        // è·å– canvas å…ƒç´ 
        const canvas = document.getElementById('score-trend-chart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ°è¶‹åŠ¿å›¾canvaså…ƒç´ ');
            return;
        }
        
        // é”€æ¯æ—§å›¾è¡¨
        if (trendChart) {
            trendChart.destroy();
            trendChart = null;
        }
        
        // å‡†å¤‡æ•°æ®
        const labels = history.map(h => new Date(h.exam_time).toLocaleDateString()).reverse();
        const scores = history.map(h => h.score_percentage).reverse();
        
        // åˆ›å»ºæ–°å›¾è¡¨
        const ctx = canvas.getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å¾—åˆ†ç‡(%)',
                    data: scores,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.max(0, Math.min(...scores) - 5),
                        max: Math.min(100, Math.max(...scores) + 5),
                        ticks: {
                            stepSize: 5,
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const score = history[history.length - 1 - context.dataIndex];
                                return [
                                    `å¾—åˆ†ç‡: ${context.parsed.y}%`,
                                    `å¾—åˆ†: ${score.score}/${score.total_score}`,
                                    `æ’å: ${score.class_rank}`,
                                    `ä¸å¹³å‡åˆ†å·®: ${score.vs_average > 0 ? '+' : ''}${score.vs_average}`
                                ];
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        console.log('æˆç»©è¶‹åŠ¿å›¾æ›´æ–°æˆåŠŸ');
    } catch (error) {
        console.error('æ›´æ–°æˆç»©è¶‹åŠ¿å›¾å¤±è´¥:', error);
        showError('å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// ä¿®æ”¹ updateHistoryTable å‡½æ•°
function updateHistoryTable(history) {
    const tbody = document.querySelector('.history-table tbody');
    if (!tbody) {
        console.error('æ‰¾ä¸åˆ°å†å²è®°å½•è¡¨æ ¼');
        return;
    }
    
    tbody.innerHTML = history.map(h => `
        <tr class="hover:bg-muted/10">
            <td class="px-4 py-2">${h.exam_name}</td>
            <td class="px-4 py-2">${new Date(h.exam_time).toLocaleDateString()}</td>
            <td class="px-4 py-2 font-medium">
                ${h.score}/${h.total_score}
                <span class="text-sm text-muted-foreground ml-1">(${h.score_percentage}%)</span>
            </td>
            <td class="px-4 py-2">${h.class_rank}</td>
            <td class="px-4 py-2 ${h.vs_average > 0 ? 'text-green-600' : 'text-red-600'}">
                ${h.vs_average > 0 ? '+' : ''}${h.vs_average}
            </td>
        </tr>
    `).join('');
}

// ç¡®ä¿ Chart.js å·²åŠ è½½
function loadChartJS() {
    return new Promise((resolve, reject) => {
        if (typeof Chart !== 'undefined') {
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

// ä¿®æ”¹å¯¼å‡ºæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
document.querySelectorAll('[data-report-type]').forEach(button => {
    button.addEventListener('click', async function() {
        const reportType = this.getAttribute('data-report-type');
        const format = document.getElementById('export-format').value;
        const exportType = document.querySelector('input[name="export-type"]:checked').value;
        
        try {
            // æ£€æŸ¥å¿…è¦å‚æ•°
            const sessionId = document.getElementById('exam-session').value;
            if (exportType === 'exam' && !sessionId) {
                showError('è¯·å…ˆé€‰æ‹©è€ƒè¯•åœºæ¬¡');
                return;
            }
            
            // å¦‚æœæ˜¯å­¦ç”Ÿåˆ†æï¼Œæ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å­¦ç”Ÿ
            const selectedStudent = document.querySelector('#selected-student');
            if (exportType === 'student' && (!selectedStudent || selectedStudent.style.display === 'none')) {
                showError('è¯·å…ˆæœç´¢å¹¶é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                type: exportType,
                report_type: reportType,
                format: format,
                session_id: sessionId
            };
            
            // å¦‚æœæ˜¯å­¦ç”Ÿåˆ†æï¼Œæ·»åŠ å­¦ç”ŸID
            if (exportType === 'student') {
                const studentId = selectedStudent.dataset.studentId;
                requestData.student_id = studentId;
            }
            
            // å‘é€POSTè¯·æ±‚
            const response = await fetch('/api/analysis/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error('å¯¼å‡ºè¯·æ±‚å¤±è´¥');
            }
            
            const result = await response.json();
            
            if (result.success && result.file_url) {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = result.file_url;
                a.download = `${reportType}_report.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // æ›´æ–°æœ€åå¯¼å‡ºæ—¶é—´
                const timeSpan = document.getElementById('last-export-time');
                if (timeSpan) {
                    timeSpan.textContent = new Date().toLocaleString();
                }
                
                showSuccess('å¯¼å‡ºæˆåŠŸ');
            } else {
                throw new Error(result.error || 'å¯¼å‡ºå¤±è´¥');
            }
            
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            showError(error.message || 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            hideLoading();
        }
    });
});

// UI è¾…åŠ©å‡½æ•°
function showLoading() {
    // åˆ›å»ºåŠ è½½æç¤º
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    loadingDiv.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow-lg">
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-6 w-6 border-4 border-primary border-t-transparent"></div>
                <span>æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</span>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showSuccess(message) {
    // åˆ›å»ºæˆåŠŸæç¤º
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        errorDiv.remove();
    }, 3000);
}
</script>
{% endblock %} 