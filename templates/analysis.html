{% extends "base.html" %}

<!-- åœ¨ head éƒ¨åˆ†æ·»åŠ  Chart.jsï¼Œå…ˆå°è¯•åŠ è½½æœ¬åœ°åº“ï¼Œå¦‚æœå¤±è´¥ä¼šåœ¨JavaScriptä¸­å¤„ç† -->
<script src="/static/js/chart.umd.min.js" onerror="console.error('æ— æ³•åŠ è½½Chart.jsåº“')"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">æˆç»©åˆ†æ</h2>
    <p class="text-muted-foreground mb-6">æŸ¥çœ‹æˆç»©ç»Ÿè®¡æ•°æ®å¹¶å¯¼å‡ºåˆ†ææŠ¥å‘Šã€‚</p>

    <!-- AI Agent åˆ†æåŠ©æ‰‹ -->
    <div class="border border-border rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">AI æ™ºèƒ½åˆ†æåŠ©æ‰‹</h3>
        <button id="toggle-ai-assistant" class="bg-primary text-primary-foreground px-3 py-1.5 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2">
          <span>ğŸ¤–</span>
          <span>å±•å¼€åŠ©æ‰‹</span>
        </button>
      </div>
      
      <!-- AI åŠ©æ‰‹å¯¹è¯ç•Œé¢ -->
      <div id="ai-assistant-panel" class="hidden">
        <div class="flex flex-col space-y-4">
          <!-- å¯¹è¯å†å²åŒºåŸŸ -->
          <div id="ai-chat-history" class="h-64 overflow-y-auto bg-muted/20 rounded-lg p-4 space-y-3">
            <div class="flex items-start space-x-2">
              <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white">
                ğŸ¤–
              </div>
              <div class="bg-white rounded-lg p-3 shadow-sm max-w-[90%]">
                <p class="text-sm">æ‚¨å¥½ï¼Œæˆ‘æ˜¯AIæ™ºèƒ½åˆ†æåŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æå­¦ç”Ÿæˆç»©æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p>
                <ul class="text-sm text-muted-foreground mt-2 list-disc pl-5">
                  <li>è¯·åˆ†æå¼ ä¸‰å’Œæå››çš„ä¸€å­¦å¹´æˆç»©å¯¹æ¯”</li>
                  <li>åˆ†ææœ€è¿‘ä¸€æ¬¡è€ƒè¯•çš„å‰ååå­¦ç”Ÿç‰¹ç‚¹</li>
                  <li>åˆ†æç‹äº”çš„å†å²æˆç»©å˜åŒ–è¶‹åŠ¿</li>
                </ul>
              </div>
            </div>
          </div>
          
          <!-- åˆ†æç»“æœå±•ç¤ºåŒºåŸŸ -->
          <div id="ai-analysis-result" class="hidden">
            <div class="border border-border rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <h4 class="font-medium">åˆ†æç»“æœ</h4>
                <button id="export-ai-analysis" class="bg-primary text-primary-foreground px-3 py-1.5 rounded-md hover:bg-primary/80 transition-colors duration-200 text-sm">
                  å¯¼å‡ºåˆ†æ
                </button>
              </div>
              <div class="space-y-4">
                <!-- åˆ†æå›¾è¡¨å®¹å™¨ -->
                <div id="ai-chart-container" class="h-64 bg-muted/20 rounded-lg">
                  <canvas id="ai-analysis-chart"></canvas>
                </div>
                <!-- åˆ†ææ–‡å­—å†…å®¹ -->
                <div id="ai-analysis-text" class="text-sm bg-muted/20 rounded-lg p-4"></div>
              </div>
            </div>
          </div>
          
          <!-- è¾“å…¥åŒºåŸŸ -->
          <div class="flex items-center space-x-2">
            <input type="text" 
                   id="ai-chat-input"
                   class="flex-1 bg-input text-foreground border border-border rounded-md px-4 py-2"
                   placeholder="è¯·è¾“å…¥æ‚¨è¦åˆ†æçš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šè¯·åˆ†æå¼ ä¸‰å’Œæå››çš„ä¸€å­¦å¹´æˆç»©å¯¹æ¯”"
                   autocomplete="off" />
            <button id="ai-send-button" 
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
              å‘é€
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- è€ƒè¯•åœºæ¬¡é€‰æ‹© -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">é€‰æ‹©è€ƒè¯•åœºæ¬¡</h3>
        <div class="relative">
          <select id="exam-session" 
                  class="bg-input text-foreground border border-border rounded-md px-4 py-2 pr-8 appearance-none cursor-pointer">
            <option value="" disabled selected>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>
          </select>
          <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
        </div>
      </div>
    </div>

    <!-- æˆç»©æ¦‚è§ˆå¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="average-score">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">å¹³å‡åˆ†</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="pass-rate">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">åŠæ ¼ç‡</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
      <div class="border border-border rounded-lg p-4 hover:border-primary transition-colors duration-200" data-stat="highest-score">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">æœ€é«˜åˆ†</h4>
          <span class="text-2xl font-bold text-primary">-</span>
        </div>
        <p class="text-sm text-muted-foreground">-</p>
      </div>
    </div>

    <!-- è€ƒè¯•ä¿¡æ¯ -->
    <div class="border border-border rounded-lg p-4 mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-semibold">è€ƒè¯•ä¿¡æ¯</h4>
          <p class="text-sm text-muted-foreground mt-1">æ€»äººæ•°ï¼š<span id="total-students">-</span></p>
        </div>
        <div class="text-right">
          <p class="text-sm text-muted-foreground">æœªè¯„åˆ†äººæ•°ï¼š<span id="ungraded-count" class="font-medium text-warning">-</span></p>
        </div>
      </div>
    </div>

    <!-- åˆ†æ•°åˆ†å¸ƒå›¾è¡¨ -->
    <div class="border border-border rounded-lg p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">åˆ†æ•°åˆ†å¸ƒ</h3>
      <div class="h-64 relative">
        <canvas id="score-distribution-chart"></canvas>
      </div>
    </div>

    <!-- é¢˜ç›®åˆ†æ -->
    <div class="border border-border rounded-lg p-6 mb-8">
      <h3 class="text-lg font-semibold mb-4">é¢˜ç›®åˆ†æ</h3>
      <div class="question-analysis-container space-y-4">
        <!-- é¢˜ç›®åˆ†æå†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ’å…¥ -->
      </div>
    </div>

    <!-- è€ƒç”Ÿå†å²æˆç»©åˆ†æ -->
    <div class="border border-border rounded-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold">è€ƒç”Ÿå†å²æˆç»©åˆ†æ</h3>
            <div class="flex items-center space-x-4">
                <!-- å­¦ç”Ÿæœç´¢ -->
                <div class="relative">
                    <form id="student-search-form" class="relative" onsubmit="return false;">
                        <input type="text" 
                               id="student-search"
                               class="w-64 bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2"
                               placeholder="æœç´¢å­¦ç”Ÿå§“åæˆ–å­¦å·..."
                               autocomplete="off" />
                        <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
                    </form>
                </div>
                <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
                <select id="time-range" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
                    <option value="1year">æœ€è¿‘ä¸€å¹´</option>
                    <option value="2years">æœ€è¿‘ä¸¤å¹´</option>
                    <option value="all">å…¨éƒ¨è®°å½•</option>
                </select>
            </div>
        </div>

        <!-- é€‰ä¸­çš„å­¦ç”Ÿä¿¡æ¯ -->
        <div id="selected-student" class="mb-6 p-4 bg-muted/30 rounded-lg" style="display: none;">
            <div class="flex items-center space-x-4 mb-4">
                <span class="text-2xl">ğŸ‘¨â€ğŸ“</span>
                <div>
                    <h4 class="font-semibold"></h4>
                    <p class="text-sm text-muted-foreground"></p>
                </div>
            </div>
            
            <!-- æˆç»©è¶‹åŠ¿å›¾ -->
            <div class="mb-6">
                <h5 class="font-medium mb-3">æˆç»©è¶‹åŠ¿</h5>
                <div class="h-48 bg-muted/30 rounded-lg">
                    <canvas id="score-trend-chart"></canvas>
                </div>
            </div>

            <!-- å†å²è€ƒè¯•è®°å½•è¡¨æ ¼ -->
            <div>
                <h5 class="font-medium mb-3">å†å²è€ƒè¯•è®°å½•</h5>
                <div class="overflow-x-auto">
                    <table class="w-full history-table">
                        <thead class="bg-muted/30">
                            <tr>
                                <th class="px-4 py-2 text-left">è€ƒè¯•åç§°</th>
                                <th class="px-4 py-2 text-left">è€ƒè¯•æ—¶é—´</th>
                                <th class="px-4 py-2 text-left">å¾—åˆ†</th>
                                <th class="px-4 py-2 text-left">ç­çº§æ’å</th>
                                <th class="px-4 py-2 text-left">ä¸å¹³å‡åˆ†å·®</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æˆç»©åˆ†ææŠ¥å‘Š -->
            <div class="mt-6 space-y-4">
                <h5 class="font-medium">æˆç»©åˆ†ææŠ¥å‘Š</h5>
                <div class="space-y-2">
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ“ˆ</span>
                        <p class="text-sm text-muted-foreground">æˆç»©æ•´ä½“å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œè¿‘ä¸‰æ¬¡è€ƒè¯•å¹³å‡æå‡3.5åˆ†</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ¯</span>
                        <p class="text-sm text-muted-foreground">ä¼˜åŠ¿ç§‘ç›®ï¼šäººå·¥æ™ºèƒ½åŸºç¡€ï¼Œè¿‘æœŸè€ƒè¯•å¹³å‡åˆ†95åˆ†ä»¥ä¸Š</p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <span class="text-primary">ğŸ’¡</span>
                        <p class="text-sm text-muted-foreground">å»ºè®®ï¼šå¯ä»¥åœ¨å®é™…åº”ç”¨æ¡ˆä¾‹åˆ†ææ–¹é¢ç»§ç»­åŠ å¼º</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯¼å‡ºé€‰é¡¹éƒ¨åˆ† -->
    <div class="border border-border rounded-lg p-6">
      <h3 class="text-lg font-semibold mb-4">å¯¼å‡ºé€‰é¡¹</h3>
      <div class="space-y-6">
        <!-- å¯¼å‡ºç±»å‹é€‰æ‹© -->
        <div class="flex items-center space-x-6">
          <label class="flex items-center space-x-2">
            <input type="radio" 
                   name="export-type" 
                   value="exam" 
                   class="w-4 h-4 text-primary border-border focus:ring-primary"
                   checked>
            <span>è€ƒè¯•åœºæ¬¡åˆ†æ</span>
          </label>
          <label class="flex items-center space-x-2">
            <input type="radio" 
                   name="export-type" 
                   value="student" 
                   class="w-4 h-4 text-primary border-border focus:ring-primary">
            <span>å­¦ç”Ÿæˆç»©åˆ†æ</span>
          </label>
        </div>

        <!-- è€ƒè¯•åœºæ¬¡åˆ†æå¯¼å‡ºé€‰é¡¹ -->
        <div id="exam-export-options" class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">æ•´ä½“åˆ†ææŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«åˆ†æ•°åˆ†å¸ƒã€å¹³å‡åˆ†ã€åŠæ ¼ç‡ç­‰ç»Ÿè®¡æ•°æ®</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="analysis">
              <span>ğŸ“Š</span>
              <span>å¯¼å‡ºåˆ†ææŠ¥å‘Š</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">é¢˜ç›®åˆ†ææŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«å„é¢˜ç›®çš„éš¾åº¦ç³»æ•°ã€åŒºåˆ†åº¦ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="questions">
              <span>ğŸ“</span>
              <span>å¯¼å‡ºé¢˜ç›®åˆ†æ</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">æˆç»©æ±‡æ€»è¡¨</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©å’Œæ’åä¿¡æ¯</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="scores">
              <span>ğŸ“‘</span>
              <span>å¯¼å‡ºæˆç»©å•</span>
            </button>
          </div>
        </div>

        <!-- å­¦ç”Ÿæˆç»©åˆ†æå¯¼å‡ºé€‰é¡¹ -->
        <div id="student-export-options" class="space-y-4 hidden">
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">ä¸ªäººæˆç»©æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«å†å²æˆç»©è¶‹åŠ¿ã€æ’åå˜åŒ–ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="personal">
              <span>ğŸ“ˆ</span>
              <span>å¯¼å‡ºæˆç»©æŠ¥å‘Š</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">èƒ½åŠ›è¯Šæ–­æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«ä¼˜åŠ¿é¢˜å‹ã€è–„å¼±ç¯èŠ‚ç­‰åˆ†æ</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="ability">
              <span>ğŸ¯</span>
              <span>å¯¼å‡ºèƒ½åŠ›è¯Šæ–­</span>
            </button>
          </div>
          <div class="flex items-center justify-between">
            <div class="space-y-2">
              <h4 class="font-medium">è¿›æ­¥å»ºè®®æŠ¥å‘Š</h4>
              <p class="text-sm text-muted-foreground">åŒ…å«é’ˆå¯¹æ€§çš„å­¦ä¹ å»ºè®®å’Œæ”¹è¿›æ–¹å‘</p>
            </div>
            <button type="button"
                    class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200 flex items-center space-x-2"
                    data-report-type="improvement">
              <span>ğŸ’¡</span>
              <span>å¯¼å‡ºå­¦ä¹ å»ºè®®</span>
            </button>
          </div>
        </div>

        <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹© -->
        <div class="flex items-center justify-between pt-4 border-t border-border">
          <div class="space-x-2">
            <span class="text-sm text-muted-foreground">å¯¼å‡ºæ ¼å¼ï¼š</span>
            <select id="export-format" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
              <option value="pdf">PDFæ ¼å¼</option>
              <option value="excel">Excelæ ¼å¼</option>
              <option value="word">Wordæ ¼å¼</option>
            </select>
          </div>
          <div class="text-sm text-muted-foreground">
            ä¸Šæ¬¡å¯¼å‡ºæ—¶é—´ï¼š<span id="last-export-time">2024-03-15 14:30</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
    // åŒ…è£…æ‰€æœ‰åˆå§‹åŒ–ä»£ç 
    document.addEventListener('DOMContentLoaded', function() {
        console.log('é¡µé¢å®Œå…¨åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–...');
        loadExamSessionsFromAPI();
        initializeAIAssistant();
        
        // å¦‚æœChart.jså·²åŠ è½½ï¼Œç›´æ¥åˆå§‹åŒ–
        if (typeof Chart !== 'undefined') {
            console.log('Chart.jså·²åŠ è½½ï¼Œç«‹å³åˆå§‹åŒ–å›¾è¡¨');
            initializeCharts();
        } else {
            console.warn('Chart.jsæœªåŠ è½½ï¼Œå°è¯•åŠ¨æ€åŠ è½½');
            loadChartJS().then(() => {
                console.log('Chart.jsåŠ è½½æˆåŠŸ');
                initializeCharts();
            }).catch(err => {
                console.error('Chart.jsåŠ è½½å¤±è´¥:', err);
                showError('å›¾è¡¨åº“åŠ è½½å¤±è´¥');
            });
        }
    });
    
    // åˆå§‹åŒ–AIåŠ©æ‰‹åŠŸèƒ½
    function initializeAIAssistant() {
        const toggleButton = document.getElementById('toggle-ai-assistant');
        const aiPanel = document.getElementById('ai-assistant-panel');
        const sendButton = document.getElementById('ai-send-button');
        const chatInput = document.getElementById('ai-chat-input');
        const chatHistory = document.getElementById('ai-chat-history');
        const analysisResult = document.getElementById('ai-analysis-result');
        const exportButton = document.getElementById('export-ai-analysis');
        
        // åˆ‡æ¢AIåŠ©æ‰‹é¢æ¿æ˜¾ç¤º/éšè—
        toggleButton.addEventListener('click', function() {
            if (aiPanel.classList.contains('hidden')) {
                aiPanel.classList.remove('hidden');
                toggleButton.querySelector('span:last-child').textContent = 'æ”¶èµ·åŠ©æ‰‹';
            } else {
                aiPanel.classList.add('hidden');
                toggleButton.querySelector('span:last-child').textContent = 'å±•å¼€åŠ©æ‰‹';
            }
        });
        
        // å‘é€æ¶ˆæ¯åŠŸèƒ½
        function sendMessage() {
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²
            addMessageToChat('user', userInput);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            
            // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒçš„æç¤º
            addThinkingMessage();
            
            // å‘é€è¯·æ±‚åˆ°åç«¯
            sendToAI(userInput);
        }
        
        // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', sendMessage);
        
        // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.isComposing) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å†å²
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start space-x-2';
            
            let avatar, messageClass;
            
            if (role === 'user') {
                avatar = 'ğŸ‘¤';
                messageClass = 'bg-primary/10';
            } else {
                avatar = 'ğŸ¤–';
                messageClass = 'bg-white';
            }
            
            messageDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white">
                    ${avatar}
                </div>
                <div class="${messageClass} rounded-lg p-3 shadow-sm max-w-[90%]">
                    <p class="text-sm">${content}</p>
                </div>
            `;
            
            chatHistory.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ·»åŠ AIæ€è€ƒä¸­çš„æç¤ºæ¶ˆæ¯
        function addThinkingMessage() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'flex items-start space-x-2 thinking-message';
            thinkingDiv.innerHTML = `
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white">
                    ğŸ¤–
                </div>
                <div class="bg-white rounded-lg p-3 shadow-sm max-w-[90%] flex items-center">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatHistory.appendChild(thinkingDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // æ·»åŠ CSSæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .typing-indicator {
                    display: flex;
                    align-items: center;
                }
                .typing-indicator span {
                    height: 8px;
                    width: 8px;
                    background: #5C7CFA;
                    border-radius: 50%;
                    display: block;
                    margin: 0 2px;
                    opacity: 0.4;
                    animation: typing 1s infinite;
                }
                .typing-indicator span:nth-child(1) {
                    animation-delay: 0s;
                }
                .typing-indicator span:nth-child(2) {
                    animation-delay: 0.2s;
                }
                .typing-indicator span:nth-child(3) {
                    animation-delay: 0.4s;
                }
                @keyframes typing {
                    0% { opacity: 0.4; transform: scale(1); }
                    50% { opacity: 1; transform: scale(1.2); }
                    100% { opacity: 0.4; transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // ç§»é™¤æ€è€ƒä¸­çš„æç¤ºæ¶ˆæ¯
        function removeThinkingMessage() {
            const thinkingMessage = document.querySelector('.thinking-message');
            if (thinkingMessage) {
                thinkingMessage.remove();
            }
        }
        
        // å‘é€è¯·æ±‚åˆ°AIæœåŠ¡
        async function sendToAI(userQuery) {
            try {
                const sessionId = document.getElementById('exam-session').value;
                
                const response = await fetch('/api/ai/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: userQuery,
                        session_id: sessionId || null
                    })
                });
                
                if (!response.ok) {
                    // å¦‚æœæ˜¯401æœªæˆæƒé”™è¯¯ï¼Œæ˜¾ç¤ºç™»å½•è¿‡æœŸçš„æç¤º
                    if (response.status === 401) {
                        throw new Error('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢åé‡æ–°ç™»å½•');
                    } else {
                        throw new Error('è¯·æ±‚AIåˆ†æå¤±è´¥: ' + response.status);
                    }
                }
                
                const result = await response.json();
                
                // ç§»é™¤æ­£åœ¨æ€è€ƒçš„æç¤º
                removeThinkingMessage();
                
                // æ·»åŠ AIå›å¤åˆ°èŠå¤©å†å²
                addMessageToChat('ai', result.message);
                
                // å¦‚æœæœ‰åˆ†æç»“æœï¼Œæ˜¾ç¤ºåˆ†æåŒºåŸŸ
                if (result.analysis) {
                    analysisResult.classList.remove('hidden');
                    
                    // æ›´æ–°åˆ†ææ–‡æœ¬
                    const analysisText = document.getElementById('ai-analysis-text');
                    analysisText.innerHTML = result.analysis.text;
                    
                    // å¦‚æœæœ‰å›¾è¡¨æ•°æ®ï¼Œç»˜åˆ¶å›¾è¡¨
                    if (result.analysis.chart) {
                        drawAIAnalysisChart(result.analysis.chart);
                    }
                }
                
            } catch (error) {
                console.error('AIåˆ†æè¯·æ±‚å¤±è´¥:', error);
                
                // ç§»é™¤æ­£åœ¨æ€è€ƒçš„æç¤º
                removeThinkingMessage();
                
                // æ·»åŠ é”™è¯¯æ¶ˆæ¯
                addMessageToChat('ai', 'æŠ±æ­‰ï¼Œåˆ†æè¯·æ±‚å¤±è´¥ã€‚' + error.message);
                
                // å¦‚æœæ˜¯ç™»å½•è¿‡æœŸï¼Œæ˜¾ç¤ºæ›´æ˜æ˜¾çš„æç¤º
                if (error.message.includes('ç™»å½•çŠ¶æ€å·²è¿‡æœŸ')) {
                    showError(error.message);
                    // æ·»åŠ å»¶è¿Ÿåè‡ªåŠ¨åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 3000);
                } else {
                    showError('AIåˆ†æè¯·æ±‚å¤±è´¥: ' + error.message);
                }
            }
        }
        
        // ç»˜åˆ¶AIåˆ†æå›¾è¡¨
        function drawAIAnalysisChart(chartData) {
            const canvas = document.getElementById('ai-analysis-chart');
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å›¾è¡¨
            if (window.aiAnalysisChart) {
                window.aiAnalysisChart.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            window.aiAnalysisChart = new Chart(canvas, {
                type: chartData.type,
                data: chartData.data,
                options: chartData.options || {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // å¯¼å‡ºåˆ†æç»“æœ
        exportButton.addEventListener('click', async function() {
            try {
                showLoading();
                
                const format = document.getElementById('export-format').value;
                
                const response = await fetch('/api/ai/export-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        format: format
                    })
                });
                
                if (!response.ok) {
                    // å¦‚æœæ˜¯401æœªæˆæƒé”™è¯¯ï¼Œæ˜¾ç¤ºç™»å½•è¿‡æœŸçš„æç¤º
                    if (response.status === 401) {
                        throw new Error('ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°é¡µé¢åé‡æ–°ç™»å½•');
                    } else {
                        throw new Error('å¯¼å‡ºåˆ†æç»“æœå¤±è´¥: ' + response.status);
                    }
                }
                
                const result = await response.json();
                
                if (result.success && result.file_url) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const a = document.createElement('a');
                    a.href = result.file_url;
                    a.download = `ai_analysis_report.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // æ›´æ–°æœ€åå¯¼å‡ºæ—¶é—´
                    const timeSpan = document.getElementById('last-export-time');
                    if (timeSpan) {
                        timeSpan.textContent = new Date().toLocaleString();
                    }
                    
                    showSuccess('AIåˆ†ææŠ¥å‘Šå¯¼å‡ºæˆåŠŸ');
                } else {
                    throw new Error(result.error || 'å¯¼å‡ºå¤±è´¥');
                }
                
            } catch (error) {
                console.error('å¯¼å‡ºAIåˆ†æå¤±è´¥:', error);
                
                // å¦‚æœæ˜¯ç™»å½•è¿‡æœŸï¼Œæ˜¾ç¤ºæ›´æ˜æ˜¾çš„æç¤ºå¹¶é‡å®šå‘
                if (error.message.includes('ç™»å½•çŠ¶æ€å·²è¿‡æœŸ')) {
                    showError(error.message);
                    // æ·»åŠ å»¶è¿Ÿåè‡ªåŠ¨åˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        window.location.href = '/logout';
                    }, 3000);
                } else {
                    showError(error.message || 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } finally {
                hideLoading();
            }
        });
    }
    
    // ä»APIåŠ è½½è€ƒè¯•åœºæ¬¡æ•°æ®
    function loadExamSessionsFromAPI() {
        console.log('æ­£åœ¨åŠ è½½è€ƒè¯•åœºæ¬¡åˆ—è¡¨');
        const examSession = document.getElementById('exam-session');
        if (!examSession) {
            console.error('æ‰¾ä¸åˆ°è€ƒè¯•åœºæ¬¡ä¸‹æ‹‰èœå•å…ƒç´ ');
            return;
        }
        
        // ä½¿ç”¨æ— éœ€ç™»å½•éªŒè¯çš„APIç«¯ç‚¹
        fetch('/api/analysis/sessions')
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–è€ƒè¯•åœºæ¬¡å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('è·å–åˆ°è€ƒè¯•åœºæ¬¡æ•°æ®:', data);
                
                if (data && data.length > 0) {
                    examSession.innerHTML = '<option value="" disabled>è¯·é€‰æ‹©è€ƒè¯•åœºæ¬¡</option>';
                    
                    // å¡«å……ä¸‹æ‹‰èœå•
                    data.forEach(session => {
                        const startDate = new Date(session.start_time).toLocaleDateString();
                        examSession.innerHTML += `<option value="${session.id}">${session.name} (${startDate})</option>`;
                    });
                    
                    // é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
                    if (examSession.options.length > 1) {
                        examSession.selectedIndex = 1;
                        
                        // è§¦å‘changeäº‹ä»¶åŠ è½½ç»Ÿè®¡æ•°æ®
                        const selectedId = examSession.value;
                        if (selectedId) {
                            loadStatsFromAPI(selectedId);
                        }
                    }
                    
                    console.log('æˆåŠŸåŠ è½½è€ƒè¯•åœºæ¬¡é€‰é¡¹');
                    
                    // è®¾ç½®changeäº‹ä»¶ç›‘å¬å™¨
                    examSession.addEventListener('change', function() {
                        const selectedId = this.value;
                        if (selectedId) {
                            loadStatsFromAPI(selectedId);
                        }
                    });
                    
                } else {
                    examSession.innerHTML = '<option value="" disabled selected>æš‚æ— å¯ç”¨è€ƒè¯•åœºæ¬¡</option>';
                    console.log('è€ƒè¯•åœºæ¬¡åˆ—è¡¨ä¸ºç©º');
                }
            })
            .catch(error => {
                console.error('åŠ è½½è€ƒè¯•åœºæ¬¡å‡ºé”™:', error);
                examSession.innerHTML = '<option value="" disabled selected>åŠ è½½å¤±è´¥</option>';
            });
    }
    
    // ä»APIåŠ è½½ç»Ÿè®¡æ•°æ®
    function loadStatsFromAPI(sessionId) {
        console.log('å¼€å§‹è·å–ç»Ÿè®¡æ•°æ®ï¼Œè€ƒè¯•ID:', sessionId);
        
        // è·å–åŸºæœ¬ç»Ÿè®¡æ•°æ®
        fetch(`/api/analysis/basic-stats/${sessionId}`)
            .then(response => response.json())
            .then(data => {
                console.log('è·å–åˆ°ç»Ÿè®¡æ•°æ®:', data);
                
                // æŸ¥æ‰¾å…·ä½“å…ƒç´ å¹¶ç›´æ¥æ›´æ–°
                const avgScoreEl = document.querySelector('[data-stat="average-score"] span.text-2xl');
                if (avgScoreEl) {
                    avgScoreEl.textContent = data.average_score || '0';
                    console.log('æ›´æ–°å¹³å‡åˆ†æ˜¾ç¤º:', avgScoreEl.textContent);
                } else {
                    console.error('æœªæ‰¾åˆ°å¹³å‡åˆ†å…ƒç´ ');
                    // å°è¯•ä½¿ç”¨æ›´é€šç”¨çš„é€‰æ‹©å™¨
                    const allAverageEls = document.querySelectorAll('[data-stat="average-score"]');
                    console.log('æ‰¾åˆ°çš„å¹³å‡åˆ†å®¹å™¨æ•°é‡:', allAverageEls.length);
                    allAverageEls.forEach(el => {
                        const span = el.querySelector('.text-2xl');
                        if (span) span.textContent = data.average_score || '0';
                    });
                }
                
                // åŒæ ·å¤„ç†åŠæ ¼ç‡
                const passRateEl = document.querySelector('[data-stat="pass-rate"] span.text-2xl');
                if (passRateEl) {
                    passRateEl.textContent = (data.pass_rate || '0') + '%';
                }
                
                // æœ€é«˜åˆ†
                const highScoreEl = document.querySelector('[data-stat="highest-score"] span.text-2xl');
                if (highScoreEl) {
                    highScoreEl.textContent = data.highest_score || '0';
                }
                
                // å­¦ç”Ÿæ€»æ•°å’Œæœªè¯„åˆ†æ•°é‡
                document.getElementById('total-students').textContent = data.total_students || '0';
                const ungradedEl = document.getElementById('ungraded-count');
                if (ungradedEl) {
                    ungradedEl.textContent = data.ungraded_count || '0';
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å‡ºé”™:', error);
            });

        // è·å–åˆ†æ•°åˆ†å¸ƒæ•°æ®
        fetch(`/api/analysis/score-distribution/${sessionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('è·å–åˆ†æ•°åˆ†å¸ƒæ•°æ®å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(distribution => {
                console.log('è·å–åˆ°åˆ†æ•°åˆ†å¸ƒæ•°æ®:', distribution);
                drawDistributionChart(distribution);
            })
            .catch(error => {
                console.error('åŠ è½½åˆ†æ•°åˆ†å¸ƒæ•°æ®å‡ºé”™:', error);
            });

        // è·å–é¢˜ç›®åˆ†ææ•°æ®
        fetch(`/api/analysis/question-analysis/${sessionId}`)
            .then(response => {
            if (!response.ok) {
                    throw new Error('è·å–é¢˜ç›®åˆ†ææ•°æ®å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(analysis => {
                console.log('è·å–åˆ°é¢˜ç›®åˆ†ææ•°æ®:', analysis);
                updateQuestionAnalysis(analysis);
            })
            .catch(error => {
                console.error('åŠ è½½é¢˜ç›®åˆ†ææ•°æ®å‡ºé”™:', error);
            });
    }

    // åœ¨drawDistributionChartå‡½æ•°å¼€å§‹æ·»åŠ è°ƒè¯•ä¿¡æ¯
    window.drawDistributionChart = function(distribution) {
        console.log('å¼€å§‹ç»˜åˆ¶åˆ†å¸ƒå›¾è¡¨ï¼Œæ•°æ®:', distribution);
        
        // ç¡®ä¿Chartå¯¹è±¡å­˜åœ¨
        if (typeof Chart === 'undefined') {
            console.error('Chartå¯¹è±¡æœªåŠ è½½ï¼Œæ— æ³•åˆ›å»ºå›¾è¡¨');
            showError('å›¾è¡¨åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
        }
        
        const canvas = document.getElementById('score-distribution-chart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ°å›¾è¡¨canvaså…ƒç´ ');
            return;
        }

        // å¦‚æœå·²å­˜åœ¨å›¾è¡¨ï¼Œå…ˆé”€æ¯å®ƒ
        if (window.distributionChart) {
            window.distributionChart.destroy();
        }

        // ä¿®æ”¹drawDistributionChartå‡½æ•°ï¼Œå¤„ç†æ•°æ®ä¸å­˜åœ¨çš„æƒ…å†µ
        if (!distribution || distribution.length === 0) {
            console.warn('æ²¡æœ‰åˆ†æ•°åˆ†å¸ƒæ•°æ®');
            // åˆ›å»ºé»˜è®¤çš„ç©ºæ•°æ®åˆ†å¸ƒ
            distribution = [
                {range: '90-100', count: 0, ungraded: 0},
                {range: '80-89', count: 0, ungraded: 0},
                {range: '70-79', count: 0, ungraded: 0},
                {range: '60-69', count: 0, ungraded: 0},
                {range: '0-59', count: 0, ungraded: 0}
            ];
        }

        // å‡†å¤‡æ•°æ®
        const data = {
            labels: distribution.map(d => d.range),
            datasets: [{
                label: 'å·²è¯„åˆ†äººæ•°',
                data: distribution.map(d => d.count - d.ungraded),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'æœªè¯„åˆ†äººæ•°',
                data: distribution.map(d => d.ungraded),
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                stack: 'Stack 0'
            }]
        };

        // é…ç½®é€‰é¡¹
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    stacked: true
                },
                x: {
                    stacked: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        };

        try {
            // åˆ›å»ºæ–°å›¾è¡¨
            window.distributionChart = new Chart(canvas, {
                type: 'bar',
                data: data,
                options: options
            });
            console.log('åˆ†å¸ƒå›¾è¡¨åˆ›å»ºæˆåŠŸ');
        } catch (error) {
            console.error('åˆ›å»ºåˆ†å¸ƒå›¾è¡¨å¤±è´¥:', error);
            showError('å›¾è¡¨åˆ›å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    };
</script>
<script>
// ç¡®ä¿ Chart.js åŠ è½½
if (typeof Chart === 'undefined') {
    console.warn('Chart.jsæœªåŠ è½½ï¼Œå°è¯•åŠ è½½æ¨¡æ‹Ÿåº“');
    // å…ˆå°è¯•åŠ è½½æœ¬åœ°Chart.js
    const script = document.createElement('script');
    script.src = '/static/js/chart.umd.min.js';
    script.onload = function() {
        console.log('Chart.js åŠ è½½æˆåŠŸ');
        initializeCharts();
    };
    script.onerror = function() {
        console.error('Chart.js åŠ è½½å¤±è´¥ï¼ŒåŠ è½½æ¨¡æ‹Ÿåº“');
        // åŠ è½½æ¨¡æ‹Ÿåº“
        const mockScript = document.createElement('script');
        mockScript.src = '/static/js/chart-mock.js';
        mockScript.onload = function() {
            console.log('Chart.js æ¨¡æ‹Ÿåº“åŠ è½½æˆåŠŸ');
            initializeCharts();
        };
        mockScript.onerror = function() {
            console.error('Chart.js æ¨¡æ‹Ÿåº“åŠ è½½ä¹Ÿå¤±è´¥äº†');
            showError('å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼ŒåŠŸèƒ½å¯èƒ½å—é™');
        };
        document.head.appendChild(mockScript);
    };
    document.head.appendChild(script);
} else {
    console.log('Chart.js å·²åŠ è½½');
    initializeCharts();
}

// åœ¨å…¨å±€ä½œç”¨åŸŸæ·»åŠ å˜é‡
let trendChart = null;

// å¯¼å‡ºç›¸å…³çš„å˜é‡
let selectedExportType = 'exam';
let selectedFormat = 'pdf';
let lastExportTime = null;

// UI è¾…åŠ©å‡½æ•° - æå‰å®šä¹‰è¿™äº›å‡½æ•°ï¼Œç¡®ä¿ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨
function showLoading() {
    // åˆ›å»ºåŠ è½½æç¤º
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'loading-overlay';
    loadingDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    loadingDiv.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow-lg">
            <div class="flex items-center space-x-2">
                <div class="animate-spin rounded-full h-6 w-6 border-4 border-primary border-t-transparent"></div>
                <span>æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</span>
            </div>
        </div>
    `;
    document.body.appendChild(loadingDiv);
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function showSuccess(message) {
    // åˆ›å»ºæˆåŠŸæç¤º
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        successDiv.remove();
    }, 3000);
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
    errorDiv.textContent = message;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
        errorDiv.remove();
    }, 3000);
}

// ç¡®ä¿ Chart.js å·²åŠ è½½
function loadChartJS() {
    return new Promise((resolve, reject) => {
        if (typeof Chart !== 'undefined') {
            resolve();
            return;
        }

        // å…ˆå°è¯•åŠ è½½æœ¬åœ°Chart.js
        const script = document.createElement('script');
        script.src = '/static/js/chart.umd.min.js';
        script.onload = resolve;
        script.onerror = function() {
            // å¦‚æœå¤±è´¥ï¼Œå°è¯•åŠ è½½æ¨¡æ‹Ÿåº“
            const mockScript = document.createElement('script');
            mockScript.src = '/static/js/chart-mock.js';
            mockScript.onload = resolve;
            mockScript.onerror = reject;
            document.head.appendChild(mockScript);
        };
        document.head.appendChild(script);
    });
}

// å°†æ‰€æœ‰å›¾è¡¨ç›¸å…³çš„ä»£ç ç§»åˆ°è¿™ä¸ªå‡½æ•°ä¸­
function initializeCharts() {
    console.log('åˆå§‹åŒ–å›¾è¡¨åŠŸèƒ½');
    const examSession = document.getElementById('exam-session');
    const studentSearch = document.getElementById('student-search');
    let distributionChart = null;

    // ç»˜åˆ¶åˆ†æ•°åˆ†å¸ƒå›¾è¡¨
    window.drawDistributionChart = function(distribution) {
        console.log('å¼€å§‹ç»˜åˆ¶åˆ†å¸ƒå›¾è¡¨ï¼Œæ•°æ®:', distribution);
        
        // ç¡®ä¿Chartå¯¹è±¡å­˜åœ¨
        if (typeof Chart === 'undefined') {
            console.error('Chartå¯¹è±¡æœªåŠ è½½ï¼Œæ— æ³•åˆ›å»ºå›¾è¡¨');
            showError('å›¾è¡¨åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
        }
        
        const canvas = document.getElementById('score-distribution-chart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ°å›¾è¡¨canvaså…ƒç´ ');
            return;
        }

        // å¦‚æœå·²å­˜åœ¨å›¾è¡¨ï¼Œå…ˆé”€æ¯å®ƒ
        if (distributionChart) {
            distributionChart.destroy();
        }

        // ä¿®æ”¹drawDistributionChartå‡½æ•°ï¼Œå¤„ç†æ•°æ®ä¸å­˜åœ¨çš„æƒ…å†µ
        if (!distribution || distribution.length === 0) {
            console.warn('æ²¡æœ‰åˆ†æ•°åˆ†å¸ƒæ•°æ®');
            // åˆ›å»ºé»˜è®¤çš„ç©ºæ•°æ®åˆ†å¸ƒ
            distribution = [
                {range: '90-100', count: 0, ungraded: 0},
                {range: '80-89', count: 0, ungraded: 0},
                {range: '70-79', count: 0, ungraded: 0},
                {range: '60-69', count: 0, ungraded: 0},
                {range: '0-59', count: 0, ungraded: 0}
            ];
        }

        // å‡†å¤‡æ•°æ®
        const data = {
            labels: distribution.map(d => d.range),
            datasets: [{
                label: 'å·²è¯„åˆ†äººæ•°',
                data: distribution.map(d => d.count - d.ungraded),
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'æœªè¯„åˆ†äººæ•°',
                data: distribution.map(d => d.ungraded),
                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1,
                stack: 'Stack 0'
            }]
        };

        // é…ç½®é€‰é¡¹
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    stacked: true
                },
                x: {
                    stacked: true
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        };

        try {
            // åˆ›å»ºæ–°å›¾è¡¨
            distributionChart = new Chart(canvas, {
                type: 'bar',
                data: data,
                options: options
            });
            console.log('åˆ†å¸ƒå›¾è¡¨åˆ›å»ºæˆåŠŸ');
        } catch (error) {
            console.error('åˆ›å»ºåˆ†å¸ƒå›¾è¡¨å¤±è´¥:', error);
            showError('å›¾è¡¨åˆ›å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    };

    // æ›´æ–°é¢˜ç›®åˆ†ææ˜¾ç¤º
    window.updateQuestionAnalysis = function(analysis) {
        const container = document.querySelector('.question-analysis-container');
        if (!container) {
            console.error('æ‰¾ä¸åˆ°é¢˜ç›®åˆ†æå®¹å™¨');
            return;
        }
                        
        if (!analysis || analysis.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-muted-foreground">
                    æš‚æ— é¢˜ç›®åˆ†ææ•°æ®
                </div>
            `;
            return;
        }

        container.innerHTML = analysis.map((q, index) => `
            <div class="flex flex-col gap-4 p-4 bg-white rounded-lg shadow-sm mb-4">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium mb-2">ç¬¬${index + 1}é¢˜</h3>
                        <p class="text-sm text-gray-600">${q.question}</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">å¹³å‡å¾—åˆ†ç‡</div>
                        <div class="text-xl font-semibold text-blue-600">
                            ${(q.average_score_rate * 100).toFixed(1)}%
                        </div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">éš¾åº¦ç³»æ•°</div>
                        <div class="text-xl font-semibold text-green-600">
                            ${q.difficulty.toFixed(2)}
                        </div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">åŒºåˆ†åº¦</div>
                        <div class="text-xl font-semibold text-purple-600">
                            ${q.discrimination.toFixed(2)}
                        </div>
                    </div>
                    </div>
                </div>
            `).join('');
    };

    // åˆå§‹åŒ–å­¦ç”Ÿæœç´¢åŠŸèƒ½
    function initializeStudentSearch() {
        console.log('åˆå§‹åŒ–å­¦ç”Ÿæœç´¢åŠŸèƒ½');
        
        const searchForm = document.getElementById('student-search-form');
        const searchInput = document.getElementById('student-search');
        const timeRange = document.getElementById('time-range');
        
        // æ·»åŠ æœç´¢æŒ‰é’®åˆ°è¡¨å•ä¸­
        const searchButton = document.createElement('button');
        searchButton.type = 'button';
        searchButton.className = 'absolute right-2 top-1/2 -translate-y-1/2 bg-primary text-primary-foreground rounded-md px-2 py-1 text-sm';
        searchButton.innerHTML = 'æœç´¢';
        searchButton.style.height = '28px';
        searchButton.style.lineHeight = '1';
        searchForm.appendChild(searchButton);
        
        // å¤„ç†æœç´¢
        async function handleSearch(searchTerm) {
            try {
                console.log('æœç´¢å­¦ç”Ÿ:', searchTerm);
                const encodedTerm = encodeURIComponent(searchTerm);
                console.log('ç¼–ç åçš„æœç´¢è¯:', encodedTerm);
                
                const response = await fetch(`/api/analysis/student-history/${encodedTerm}`);
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`æœç´¢è¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('æœç´¢ç»“æœ:', data);
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // æ›´æ–°å­¦ç”Ÿä¿¡æ¯æ˜¾ç¤º
                const studentInfo = document.querySelector('#selected-student');
                if (studentInfo) {
                    studentInfo.style.display = 'block';
                    studentInfo.dataset.studentId = data.student.id;
                    const nameElement = studentInfo.querySelector('h4');
                    const idElement = studentInfo.querySelector('p');
                    if (nameElement && idElement) {
                        nameElement.textContent = data.student.name;
                        idElement.textContent = `å­¦å·ï¼š${data.student.student_id}`;
                    }
                }
                
                // æ›´æ–°å†å²è®°å½•
                if (data.history && data.history.length > 0) {
                    updateHistoryTable(data.history);
                        await updateScoreTrendChart(data.history);
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                showError('æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
            }
        }
        
        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        searchButton.addEventListener('click', function() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length >= 2) {
                handleSearch(searchTerm);
            } else {
                showError('è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦è¿›è¡Œæœç´¢');
            }
        });
        
        // ç›‘å¬æœç´¢è¾“å…¥ - ç§»é™¤è‡ªåŠ¨æœç´¢åŠŸèƒ½ï¼Œæ”¹ä¸ºåªåœ¨æŒ‰é’®ç‚¹å‡»æˆ–è¡¨å•æäº¤æ—¶æœç´¢
        let isComposing = false;
        
        // æ·»åŠ ä¸­æ–‡è¾“å…¥æ³•äº‹ä»¶ç›‘å¬ï¼Œä»…ç”¨äºè·Ÿè¸ªè¾“å…¥çŠ¶æ€
        searchInput.addEventListener('compositionstart', function() {
            isComposing = true;
        });
        
        searchInput.addEventListener('compositionend', function() {
            isComposing = false;
        });
        
        // ç›‘å¬è¡¨å•æäº¤
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // å¦‚æœæ­£åœ¨è¾“å…¥ä¸­æ–‡ï¼Œä¸è§¦å‘æœç´¢
            if (isComposing) return;
            
            const searchTerm = searchInput.value.trim();
            if (searchTerm.length >= 2) {
                handleSearch(searchTerm);
            } else {
                showError('è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦è¿›è¡Œæœç´¢');
            }
        });
        
        // ç›‘å¬å›è½¦é”®
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !isComposing) {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length >= 2) {
                    handleSearch(searchTerm);
                } else {
                    showError('è¯·è¾“å…¥è‡³å°‘2ä¸ªå­—ç¬¦è¿›è¡Œæœç´¢');
                }
            }
        });
        
        // ç›‘å¬æ—¶é—´èŒƒå›´å˜åŒ–
        timeRange.addEventListener('change', function() {
            const studentInfo = document.querySelector('#selected-student');
            if (studentInfo && studentInfo.style.display !== 'none') {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    handleSearch(searchTerm);
                }
            }
        });
    }

    // ç¡®ä¿åœ¨ DOM åŠ è½½å®Œæˆååˆå§‹åŒ–æœç´¢åŠŸèƒ½
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeStudentSearch);
    } else {
        initializeStudentSearch();
    }

    // åˆå§‹åŒ–è¶‹åŠ¿å›¾
    function initTrendChart() {
        // ç¡®ä¿åœ¨åˆ›å»ºæ–°å›¾è¡¨å‰é”€æ¯æ—§å›¾è¡¨
        if (trendChart) {
            trendChart.destroy();
            trendChart = null;
        }
    
        // åˆå§‹åŒ–è¶‹åŠ¿å›¾çš„é…ç½®
        const ctx = document.getElementById('score-trend-chart');
        if (ctx) {
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'è€ƒè¯•æˆç»©',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
    }
    
    // åˆå§‹åŒ–è¶‹åŠ¿å›¾
    initTrendChart();
}

// ä¿®æ”¹ updateScoreTrendChart å‡½æ•°
async function updateScoreTrendChart(history) {
    if (!history || history.length === 0) {
        console.warn('æ²¡æœ‰å†å²æ•°æ®ç”¨äºæ›´æ–°è¶‹åŠ¿å›¾');
        return;
    }
    
    try {
        // ç¡®ä¿ Chart.js å·²åŠ è½½
        await loadChartJS();
        
        // è·å– canvas å…ƒç´ 
        const canvas = document.getElementById('score-trend-chart');
        if (!canvas) {
            console.error('æ‰¾ä¸åˆ°è¶‹åŠ¿å›¾canvaså…ƒç´ ');
            return;
        }
        
        // å¦‚æœè¶‹åŠ¿å›¾ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„
        if (!trendChart) {
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('æ— æ³•è·å–canvasä¸Šä¸‹æ–‡');
                return;
            }
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å¾—åˆ†ç‡(%)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        // å‡†å¤‡æ•°æ®
        const labels = history.map(h => new Date(h.exam_time).toLocaleDateString()).reverse();
        const scores = history.map(h => h.score_percentage).reverse();
        
        if (scores.length === 0) {
            console.warn('æ²¡æœ‰åˆ†æ•°æ•°æ®å¯æ˜¾ç¤º');
            return;
        }
        
        // é”€æ¯æ—§å›¾è¡¨å¹¶åˆ›å»ºæ–°å›¾è¡¨å¯èƒ½æ›´å®‰å…¨
        if (trendChart) {
            trendChart.destroy();
        }
        
        // åˆ›å»ºæ–°å›¾è¡¨
        const ctx = canvas.getContext('2d');
        trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å¾—åˆ†ç‡(%)',
                    data: scores,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: Math.max(0, Math.min(...scores) - 5),
                        max: Math.min(100, Math.max(...scores) + 5),
                        ticks: {
                            stepSize: 5,
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        reverse: false
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const score = history[history.length - 1 - context.dataIndex];
                                return [
                                    `å¾—åˆ†ç‡: ${context.parsed.y}%`,
                                    `å¾—åˆ†: ${score.score}/${score.total_score}`,
                                    `æ’å: ${score.class_rank}`,
                                    `ä¸å¹³å‡åˆ†å·®: ${score.vs_average > 0 ? '+' : ''}${score.vs_average}`
                                ];
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        console.log('æˆç»©è¶‹åŠ¿å›¾æ›´æ–°æˆåŠŸ');
    } catch (error) {
        console.error('æ›´æ–°æˆç»©è¶‹åŠ¿å›¾å¤±è´¥:', error);
        showError('å›¾è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å‡½æ•°å¯ä»¥å¤„ç†
    }
}

// ä¿®æ”¹ updateHistoryTable å‡½æ•°
function updateHistoryTable(history) {
    const tbody = document.querySelector('.history-table tbody');
    if (!tbody) {
        console.error('æ‰¾ä¸åˆ°å†å²è®°å½•è¡¨æ ¼');
        return;
    }
    
    if (!history || history.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-4 py-2 text-center text-muted-foreground">
                    æš‚æ— è€ƒè¯•è®°å½•
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = history.map(h => `
        <tr class="hover:bg-muted/10">
            <td class="px-4 py-2">${h.exam_name}</td>
            <td class="px-4 py-2">${new Date(h.exam_time).toLocaleDateString()}</td>
            <td class="px-4 py-2 font-medium">
                ${h.score}/${h.total_score}
                <span class="text-sm text-muted-foreground ml-1">(${h.score_percentage}%)</span>
            </td>
            <td class="px-4 py-2">${h.class_rank}</td>
            <td class="px-4 py-2 ${h.vs_average > 0 ? 'text-green-600' : 'text-red-600'}">
                ${h.vs_average > 0 ? '+' : ''}${h.vs_average}
            </td>
        </tr>
    `).join('');
}

// ä¿®æ”¹å¯¼å‡ºæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
document.querySelectorAll('[data-report-type]').forEach(button => {
    button.addEventListener('click', async function() {
        const reportType = this.getAttribute('data-report-type');
        const format = document.getElementById('export-format').value;
        const exportType = document.querySelector('input[name="export-type"]:checked').value;
        
        try {
            // æ£€æŸ¥å¿…è¦å‚æ•°
            const sessionId = document.getElementById('exam-session').value;
            if (exportType === 'exam' && !sessionId) {
                showError('è¯·å…ˆé€‰æ‹©è€ƒè¯•åœºæ¬¡');
                return;
            }
            
            // å¦‚æœæ˜¯å­¦ç”Ÿåˆ†æï¼Œæ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å­¦ç”Ÿ
            const selectedStudent = document.querySelector('#selected-student');
            if (exportType === 'student' && (!selectedStudent || selectedStudent.style.display === 'none')) {
                showError('è¯·å…ˆæœç´¢å¹¶é€‰æ‹©å­¦ç”Ÿ');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();
            
            // æ„å»ºè¯·æ±‚æ•°æ®
            const requestData = {
                type: exportType,
                report_type: reportType,
                format: format,
                session_id: sessionId
            };
            
            // å¦‚æœæ˜¯å­¦ç”Ÿåˆ†æï¼Œæ·»åŠ å­¦ç”ŸID
            if (exportType === 'student') {
                const studentId = selectedStudent.dataset.studentId;
                requestData.student_id = studentId;
            }
            
            // å‘é€POSTè¯·æ±‚
            const response = await fetch('/api/analysis/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error('å¯¼å‡ºè¯·æ±‚å¤±è´¥');
            }
            
            const result = await response.json();
            
            if (result.success && result.file_url) {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = result.file_url;
                a.download = `${reportType}_report.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // æ›´æ–°æœ€åå¯¼å‡ºæ—¶é—´
                const timeSpan = document.getElementById('last-export-time');
                if (timeSpan) {
                    timeSpan.textContent = new Date().toLocaleString();
                }
                
                showSuccess('å¯¼å‡ºæˆåŠŸ');
            } else {
                throw new Error(result.error || 'å¯¼å‡ºå¤±è´¥');
            }
            
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            showError(error.message || 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        } finally {
            hideLoading();
        }
    });
});
</script>
{% endblock %} 