{% extends "base.html" %}

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">è€ƒè¯•ç®¡ç†</h2>
    <p class="text-muted-foreground mb-6">ç®¡ç†è€ƒè¯•åœºæ¬¡å’Œä¸Šä¼ è¯•å·ã€‚</p>

    <!-- é€‰é¡¹å¡åˆ‡æ¢ -->
    <div class="border-b border-border mb-6">
      <div class="flex space-x-8">
        <button id="tab-sessions" 
                class="px-4 py-2 border-b-2 border-primary text-primary font-medium">
          è€ƒè¯•åœºæ¬¡
        </button>
        <button id="tab-upload" 
                class="px-4 py-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground">
          æ–°å¢è€ƒè¯•
        </button>
        <button id="tab-agent" 
                class="px-4 py-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground">
          è€ƒè¯•æŸ¥è¯¢åŠ©æ‰‹
        </button>
      </div>
    </div>

    <!-- è€ƒè¯•åœºæ¬¡ç®¡ç†éƒ¨åˆ† -->
    <div id="sessions-content">
      <div id="session-list">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold">å·²æ·»åŠ çš„è€ƒè¯•åœºæ¬¡</h3>
          <div class="relative flex items-center">
            <input type="text" 
                   id="search-sessions" 
                   class="bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2" 
                   placeholder="æœç´¢è€ƒè¯•åœºæ¬¡..." />
            <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
            <button id="search-button" 
                    class="ml-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80">
              æœç´¢
            </button>
          </div>
        </div>
        <div class="divide-y divide-border">
          <ul id="session-items" class="space-y-4">
            <!-- è€ƒè¯•åœºæ¬¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </ul>
        </div>
      </div>
    </div>

    <!-- åœ¨å·²æœ‰å†…å®¹åæ·»åŠ è€ƒè¯•æŸ¥è¯¢åŠ©æ‰‹ç•Œé¢ -->
    <div id="agent-content" class="hidden">
      <div class="border border-border rounded-lg p-6">
        <h3 class="text-lg font-semibold mb-4">è€ƒè¯•æŸ¥è¯¢åŠ©æ‰‹</h3>
        <div class="mb-4">
          <p class="text-sm text-muted-foreground mb-2">æ‚¨å¯ä»¥å‘AIåŠ©æ‰‹è¯¢é—®æœ‰å…³è€ƒè¯•å®‰æ’çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š"4æœˆ4å·æœ‰ä»€ä¹ˆè€ƒè¯•ï¼Ÿ"</p>
        </div>
        
        <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
        <div id="chat-history" class="bg-muted/30 rounded-lg p-4 h-64 overflow-y-auto mb-4 space-y-4">
          <!-- åˆå§‹æ¶ˆæ¯ä¼šé€šè¿‡JSè‡ªåŠ¨æ·»åŠ  -->
        </div>
        
        <!-- æ·»åŠ ä¸€ä¸ªéšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡† -->
        <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="flex items-center">
          <input type="text" 
                 id="query-input" 
                 class="flex-1 bg-input text-foreground border border-border rounded-l-md px-3 py-2"
                 placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." />
          <button id="send-button" 
                  class="bg-primary text-white rounded-r-md px-4 py-2 hover:bg-primary/80">
            å‘é€
          </button>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('search-sessions');
      const searchButton = document.getElementById('search-button');
      const sessionItems = document.getElementById('session-items');
      
      async function performSearch() {
        const searchTerm = searchInput.value.trim();
        sessionItems.innerHTML = '<li class="text-center py-4">æœç´¢ä¸­...</li>';
        
        try {
          const response = await fetch(`/api/sessions?search=${encodeURIComponent(searchTerm)}`);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'æœç´¢å¤±è´¥');
          }
          
          sessionItems.innerHTML = '';
          
          if (data.length === 0) {
            sessionItems.innerHTML = `
              <li class="text-center py-4 text-muted-foreground">
                æœªæ‰¾åˆ°åŒ¹é…çš„è€ƒè¯•åœºæ¬¡
              </li>
            `;
            return;
          }
          
          data.forEach(session => {
            const li = document.createElement('li');
            li.className = 'p-4 bg-muted/30 rounded-lg flex justify-between items-center';
            
            // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
            const statusMap = {
              'pending': 'å¾…å¼€å§‹',
              'ongoing': 'è¿›è¡Œä¸­',
              'completed': 'å·²ç»“æŸ',
              'graded': 'å·²è¯„åˆ†'
            };
            
            const statusClass = {
              'pending': 'text-blue-600',
              'ongoing': 'text-green-600',
              'completed': 'text-yellow-600',
              'graded': 'text-gray-600'
            };
            
            li.innerHTML = `
              <div>
                <h4 class="text-lg font-medium">${session.name}</h4>
                <div class="text-sm text-muted-foreground">
                  <div>ç§‘ç›®ï¼š${session.subject}</div>
                  <div>å¼€å§‹ï¼š${session.start_time}</div>
                  <div>ç»“æŸï¼š${session.end_time}</div>
                  <div class="${statusClass[session.status] || 'text-gray-600'}">
                    çŠ¶æ€ï¼š${statusMap[session.status] || 'æœªçŸ¥çŠ¶æ€'}
                  </div>
                </div>
              </div>
              <button onclick="deleteSession(${session.id})" 
                      class="text-destructive hover:text-destructive/80">
                åˆ é™¤
              </button>
            `;
            sessionItems.appendChild(li);
          });
        } catch (error) {
          console.error('æœç´¢å¤±è´¥:', error);
          sessionItems.innerHTML = `
            <li class="text-center py-4 text-destructive">
              æœç´¢å¤±è´¥: ${error.message}
            </li>
          `;
        }
      }
      
      // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      searchButton.addEventListener('click', performSearch);
      
      // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch();
        }
      });
      
      // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡æœç´¢ä»¥æ˜¾ç¤ºæ‰€æœ‰è€ƒè¯•åœºæ¬¡
      performSearch();
    });

    // åˆ é™¤è€ƒè¯•åœºæ¬¡å‡½æ•°
    async function deleteSession(sessionId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè€ƒè¯•åœºæ¬¡å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/session/${sessionId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // åˆ é™¤æˆåŠŸåé‡æ–°åŠ è½½åˆ—è¡¨
          const searchButton = document.getElementById('search-button');
          if (searchButton) {
            searchButton.click();
          } else {
            location.reload(); // å¦‚æœæ‰¾ä¸åˆ°æœç´¢æŒ‰é’®å°±åˆ·æ–°é¡µé¢
          }
        } else {
          throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤è€ƒè¯•åœºæ¬¡å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // ç¡®ä¿åˆ é™¤å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
    window.deleteSession = deleteSession;
    </script>
    
    <!--æ–°å¢è€ƒè¯•éƒ¨åˆ†-->
    <div id="upload-content" class="hidden">
      <div class="container mx-auto p-6">
        <form id="exam-form" class="space-y-6">
          <!-- åŸºæœ¬ä¿¡æ¯éƒ¨åˆ† -->
          <div class="border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">åŸºæœ¬ä¿¡æ¯</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="exam-name" class="block text-sm font-medium">è€ƒè¯•åç§°</label>
                <input type="text" 
                       id="exam-name" 
                       name="name"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š2024å¹´æ˜¥å­£æœŸä¸­è€ƒè¯•" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="subject" class="block text-sm font-medium">ç§‘ç›®</label>
                <input type="text" 
                       id="subject" 
                       name="subject"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½åŸºç¡€" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="exam-time" class="block text-sm font-medium">è€ƒè¯•æ—¶é—´</label>
                <input type="datetime-local" 
                       id="exam-time" 
                       name="examTime"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       required />
              </div>
              <div class="space-y-2">
                <label for="duration" class="block text-sm font-medium">è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" 
                       id="duration" 
                       name="duration"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š120" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="total-score" class="block text-sm font-medium">è¯•å·æ€»åˆ†</label>
                <input type="number" 
                       id="total-score" 
                       name="totalScore"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š100" 
                       required />
              </div>
            </div>
          </div>

          <!-- è¯•å·æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
          <div class="border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">è¯•å·æ–‡ä»¶</h3>
            <div class="space-y-4">
              <div class="space-y-2">
                <label for="exam-file" class="block text-sm font-medium">è¯•å·æ–‡ä»¶ï¼ˆPDFæ ¼å¼ï¼‰</label>
                <input type="file" 
                       id="exam-file" 
                       name="examFile"
                       accept=".pdf"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       />
              </div>
            </div>
          </div>

          <!-- æŒ‰é’®éƒ¨åˆ† -->
          <div class="flex justify-end space-x-4">
            <button type="button" 
                    onclick="window.location.href='/dashboard'"
                    class="bg-secondary text-secondary-foreground px-4 py-2 rounded-md">
              å–æ¶ˆ
            </button>
            <button type="submit" 
                    class="bg-primary text-primary-foreground px-6 py-2 rounded-md">
              åˆ›å»ºè€ƒè¯•
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('exam-form');
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(form);
                
                // æ‰“å°è¡¨å•æ•°æ®
                console.log('æäº¤çš„æ•°æ®:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('è€ƒè¯•åˆ›å»ºæˆåŠŸï¼');
                    window.location.href = '/dashboard';
                } else {
                    throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºè€ƒè¯•å¤±è´¥:', error);
                alert('åˆ›å»ºè€ƒè¯•å¤±è´¥: ' + error.message);
            }
        });
    }
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
    const tabSessions = document.getElementById('tab-sessions');
    const tabUpload = document.getElementById('tab-upload');
    const tabAgent = document.getElementById('tab-agent');
    const sessionsContent = document.getElementById('sessions-content');
    const uploadContent = document.getElementById('upload-content');
    const agentContent = document.getElementById('agent-content');

    function switchTab(tab) {
      // é‡ç½®æ‰€æœ‰æ ‡ç­¾å’Œå†…å®¹åŒºåŸŸ
      [tabSessions, tabUpload, tabAgent].forEach(t => {
        t.classList.remove('border-primary', 'text-primary');
        t.classList.add('border-transparent', 'text-muted-foreground');
      });
      
      [sessionsContent, uploadContent, agentContent].forEach(c => {
        c.classList.add('hidden');
      });
      
      // è®¾ç½®æ´»åŠ¨æ ‡ç­¾å’Œå†…å®¹
      if (tab === 'sessions') {
        tabSessions.classList.add('border-primary', 'text-primary');
        tabSessions.classList.remove('border-transparent', 'text-muted-foreground');
        sessionsContent.classList.remove('hidden');
      } else if (tab === 'upload') {
        tabUpload.classList.add('border-primary', 'text-primary');
        tabUpload.classList.remove('border-transparent', 'text-muted-foreground');
        uploadContent.classList.remove('hidden');
      } else if (tab === 'agent') {
        tabAgent.classList.add('border-primary', 'text-primary');
        tabAgent.classList.remove('border-transparent', 'text-muted-foreground');
        agentContent.classList.remove('hidden');
      }
    }

    tabSessions.addEventListener('click', () => switchTab('sessions'));
    tabUpload.addEventListener('click', () => switchTab('upload'));
    tabAgent.addEventListener('click', () => switchTab('agent'));
    
    // å¼•ç”¨èŠå¤©å…ƒç´ 
    const queryInput = document.getElementById('query-input');
    const sendButton = document.getElementById('send-button');
    const chatHistory = document.getElementById('chat-history');
    const pdfUpload = document.getElementById('pdf-upload');
    
    // ä¿å­˜ä¸´æ—¶è€ƒè¯•ä¿¡æ¯çš„å˜é‡
    let pendingExamInfo = null;
    
    // æ¶ˆæ¯IDè®¡æ•°å™¨
    let messageCounter = 0;
    
    // åˆå§‹åŒ–èŠå¤©ï¼Œæ·»åŠ AIæ¬¢è¿æ¶ˆæ¯
    function initChat() {
      const welcomeMessage = "ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„è€ƒè¯•æŸ¥è¯¢åŠ©æ‰‹ã€‚ä½ å¯ä»¥é—®æˆ‘å…³äºè€ƒè¯•å®‰æ’çš„é—®é¢˜ï¼Œä¾‹å¦‚ç‰¹å®šæ—¥æœŸçš„è€ƒè¯•ã€‚";
      addAIMessage(welcomeMessage);
    }
    
    // ä¿®æ”¹å‘é€æŸ¥è¯¢å‡½æ•°ï¼Œå¤„ç†è€ƒè¯•åˆ›å»º
    async function sendQuery() {
      const query = queryInput.value.trim();
      if (!query) return;
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©å†å²
      addUserMessage(query);
      queryInput.value = '';
      
      // æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
      const thinkingId = addAIMessage("æ­£åœ¨æ€è€ƒ...");
      
      try {
        // åˆ¤æ–­æ˜¯å¦æ˜¯åˆ›å»ºè€ƒè¯•çš„è¯·æ±‚
        const isAddExamRequest = /æ·»åŠ .*(è€ƒè¯•|è€ƒæ ¸|æµ‹è¯•)|åˆ›å»º.*(è€ƒè¯•|è€ƒæ ¸|æµ‹è¯•)|å®‰æ’.*(è€ƒè¯•|è€ƒæ ¸|æµ‹è¯•)/.test(query);
        
        let response;
        if (isAddExamRequest) {
          // è°ƒç”¨æ·»åŠ è€ƒè¯•çš„API
          response = await fetch('/api/agent/process-exam-request', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query })
          });
        } else {
          // ä½¿ç”¨åŸæœ‰çš„æŸ¥è¯¢API
          response = await fetch('/api/agent/exam-query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query })
          });
        }
        
        if (!response.ok) {
          throw new Error('è¯·æ±‚å¤±è´¥');
        }
        
        const data = await response.json();
        
        // æ›´æ–°æ€è€ƒæ¶ˆæ¯ä¸ºå®é™…å›å¤
        updateMessage(thinkingId, data.response);
        
        // å¦‚æœæ˜¯è€ƒè¯•åˆ›å»ºæˆåŠŸï¼Œæ·»åŠ ä¸Šä¼ PDFçš„é€‰é¡¹
        if (isAddExamRequest && data.success) {
          pendingExamInfo = {
            exam_id: data.exam_id,
            exam_name: data.exam_name
          };
          
          // æ·»åŠ PDFä¸Šä¼ é€‰é¡¹æ¶ˆæ¯
          setTimeout(() => {
            const uploadOptionsId = addAIMessage(`
              æ‚¨æƒ³ä¸ºè¿™åœºè€ƒè¯•ä¸Šä¼ PDFè¯•å·å—ï¼Ÿ
              <div class="flex space-x-2 mt-2">
                <button id="upload-yes" class="bg-primary text-white px-3 py-1 rounded-md text-sm">æ˜¯ï¼Œä¸Šä¼ PDF</button>
                <button id="upload-no" class="bg-secondary text-secondary-foreground px-3 py-1 rounded-md text-sm">å¦ï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ¿</button>
              </div>
            `);
            
            // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('upload-yes').addEventListener('click', function() {
              pdfUpload.click();
            });
            
            document.getElementById('upload-no').addEventListener('click', function() {
              addAIMessage("å·²ä½¿ç”¨é»˜è®¤æ¨¡æ¿åˆ›å»ºè€ƒè¯•ï¼Œæ‚¨å¯ä»¥ç¨ååœ¨è€ƒè¯•ç®¡ç†ä¸­ä¸Šä¼ è¯•å·ã€‚");
            });
          }, 500);
        }
      } catch (error) {
        console.error('æŸ¥è¯¢å¤±è´¥:', error);
        updateMessage(thinkingId, 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚');
      }
    }
    
    // å¤„ç†PDFæ–‡ä»¶ä¸Šä¼ 
    pdfUpload.addEventListener('change', async function(e) {
      if (!pendingExamInfo || !this.files.length) return;
      
      const file = this.files[0];
      if (file.type !== 'application/pdf') {
        addAIMessage("è¯·ä¸Šä¼ PDFæ ¼å¼çš„æ–‡ä»¶ã€‚");
        return;
      }
      
      // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¶ˆæ¯
      const uploadMsgId = addAIMessage("æ­£åœ¨ä¸Šä¼ è¯•å·...");
      
      // åˆ›å»ºè¡¨å•æ•°æ®
      const formData = new FormData();
      formData.append('exam_id', pendingExamInfo.exam_id);
      formData.append('pdf_file', file);
      
      try {
        const response = await fetch('/api/agent/upload-exam-pdf', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          updateMessage(uploadMsgId, `è¯•å·ä¸Šä¼ æˆåŠŸï¼æ–‡ä»¶å: ${file.name}`);
        } else {
          throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        updateMessage(uploadMsgId, `è¯•å·ä¸Šä¼ å¤±è´¥: ${error.message}`);
      }
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥å’Œå¾…å¤„ç†è€ƒè¯•ä¿¡æ¯
      this.value = '';
      pendingExamInfo = null;
    });
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ - å³å¯¹é½
    function addUserMessage(content) {
      const messageId = `user-message-${messageCounter++}`;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start justify-end mb-4';
      messageDiv.id = messageId;
      
      messageDiv.innerHTML = `
        <div class="bg-secondary/20 p-3 rounded-lg max-w-[85%]">
          <p>${content}</p>
        </div>
        <div class="flex-shrink-0 w-8 h-8 bg-secondary rounded-full flex items-center justify-center text-white ml-2">ä½ </div>
      `;
      
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      return messageId;
    }
    
    // æ·»åŠ AIæ¶ˆæ¯ - å·¦å¯¹é½
    function addAIMessage(content) {
      const messageId = `ai-message-${messageCounter++}`;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex items-start mb-4';
      messageDiv.id = messageId;
      
      messageDiv.innerHTML = `
        <div class="flex-shrink-0 w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white mr-2">AI</div>
        <div class="bg-primary/20 p-3 rounded-lg max-w-[85%]">
          ${content}
        </div>
      `;
      
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      return messageId;
    }
    
    // æ›´æ–°æ¶ˆæ¯å†…å®¹
    function updateMessage(messageId, content) {
      const messageElement = document.getElementById(messageId);
      if (messageElement) {
        // æ£€æŸ¥æ˜¯AIæ¶ˆæ¯è¿˜æ˜¯ç”¨æˆ·æ¶ˆæ¯
        const isUserMessage = messageId.startsWith('user-message');
        
        // AIæ¶ˆæ¯å†…å®¹åœ¨ç¬¬äºŒä¸ªdivï¼Œç”¨æˆ·æ¶ˆæ¯å†…å®¹åœ¨ç¬¬ä¸€ä¸ªdiv
        const contentDiv = isUserMessage 
          ? messageElement.querySelector('div:first-child')
          : messageElement.querySelector('div:nth-child(2)');
          
        if (contentDiv) {
          contentDiv.innerHTML = content.includes('<') ? content : `<p>${content}</p>`;
          chatHistory.scrollTop = chatHistory.scrollHeight;
        }
      }
    }
    
    // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sendButton.addEventListener('click', sendQuery);
    
    // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    queryInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendQuery();
      }
    });
    
    // åˆå§‹åŒ–èŠå¤©ç•Œé¢
    initChat();
  });
</script>
{% endblock %}
