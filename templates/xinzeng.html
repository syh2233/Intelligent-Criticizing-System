{% extends "base.html" %}

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">è€ƒè¯•ç®¡ç†</h2>
    <p class="text-muted-foreground mb-6">ç®¡ç†è€ƒè¯•åœºæ¬¡å’Œä¸Šä¼ è¯•å·ã€‚</p>

    <!-- é€‰é¡¹å¡åˆ‡æ¢ -->
    <div class="border-b border-border mb-6">
      <div class="flex space-x-8">
        <button id="tab-sessions" 
                class="px-4 py-2 border-b-2 border-primary text-primary font-medium">
          è€ƒè¯•åœºæ¬¡
        </button>
        <button id="tab-upload" 
                class="px-4 py-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground">
          æ–°å¢è€ƒè¯•
        </button>
      </div>
    </div>

    <!-- è€ƒè¯•åœºæ¬¡ç®¡ç†éƒ¨åˆ† -->
    <div id="sessions-content">
      <div id="session-list">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold">å·²æ·»åŠ çš„è€ƒè¯•åœºæ¬¡</h3>
          <div class="relative flex items-center">
            <input type="text" 
                   id="search-sessions" 
                   class="bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2" 
                   placeholder="æœç´¢è€ƒè¯•åœºæ¬¡..." />
            <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
            <button id="search-button" 
                    class="ml-2 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80">
              æœç´¢
            </button>
          </div>
        </div>
        <div class="divide-y divide-border">
          <ul id="session-items" class="space-y-4">
            <!-- è€ƒè¯•åœºæ¬¡åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
          </ul>
        </div>
      </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('search-sessions');
      const searchButton = document.getElementById('search-button');
      const sessionItems = document.getElementById('session-items');
      
      async function performSearch() {
        const searchTerm = searchInput.value.trim();
        sessionItems.innerHTML = '<li class="text-center py-4">æœç´¢ä¸­...</li>';
        
        try {
          const response = await fetch(`/api/sessions?search=${encodeURIComponent(searchTerm)}`);
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.error || 'æœç´¢å¤±è´¥');
          }
          
          sessionItems.innerHTML = '';
          
          if (data.length === 0) {
            sessionItems.innerHTML = `
              <li class="text-center py-4 text-muted-foreground">
                æœªæ‰¾åˆ°åŒ¹é…çš„è€ƒè¯•åœºæ¬¡
              </li>
            `;
            return;
          }
          
          data.forEach(session => {
            const li = document.createElement('li');
            li.className = 'p-4 bg-muted/30 rounded-lg flex justify-between items-center';
            
            // æ ¼å¼åŒ–çŠ¶æ€æ˜¾ç¤º
            const statusMap = {
              'pending': 'å¾…å¼€å§‹',
              'ongoing': 'è¿›è¡Œä¸­',
              'completed': 'å·²ç»“æŸ',
              'graded': 'å·²è¯„åˆ†'
            };
            
            const statusClass = {
              'pending': 'text-blue-600',
              'ongoing': 'text-green-600',
              'completed': 'text-yellow-600',
              'graded': 'text-gray-600'
            };
            
            li.innerHTML = `
              <div>
                <h4 class="text-lg font-medium">${session.name}</h4>
                <div class="text-sm text-muted-foreground">
                  <div>ç§‘ç›®ï¼š${session.subject}</div>
                  <div>å¼€å§‹ï¼š${session.start_time}</div>
                  <div>ç»“æŸï¼š${session.end_time}</div>
                  <div class="${statusClass[session.status] || 'text-gray-600'}">
                    çŠ¶æ€ï¼š${statusMap[session.status] || 'æœªçŸ¥çŠ¶æ€'}
                  </div>
                </div>
              </div>
              <button onclick="deleteSession(${session.id})" 
                      class="text-destructive hover:text-destructive/80">
                åˆ é™¤
              </button>
            `;
            sessionItems.appendChild(li);
          });
        } catch (error) {
          console.error('æœç´¢å¤±è´¥:', error);
          sessionItems.innerHTML = `
            <li class="text-center py-4 text-destructive">
              æœç´¢å¤±è´¥: ${error.message}
            </li>
          `;
        }
      }
      
      // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      searchButton.addEventListener('click', performSearch);
      
      // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          performSearch();
        }
      });
      
      // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œä¸€æ¬¡æœç´¢ä»¥æ˜¾ç¤ºæ‰€æœ‰è€ƒè¯•åœºæ¬¡
      performSearch();
    });

    // åˆ é™¤è€ƒè¯•åœºæ¬¡å‡½æ•°
    async function deleteSession(sessionId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè€ƒè¯•åœºæ¬¡å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/session/${sessionId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // åˆ é™¤æˆåŠŸåé‡æ–°åŠ è½½åˆ—è¡¨
          const searchButton = document.getElementById('search-button');
          if (searchButton) {
            searchButton.click();
          } else {
            location.reload(); // å¦‚æœæ‰¾ä¸åˆ°æœç´¢æŒ‰é’®å°±åˆ·æ–°é¡µé¢
          }
        } else {
          throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
        }
      } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤è€ƒè¯•åœºæ¬¡å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // ç¡®ä¿åˆ é™¤å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
    window.deleteSession = deleteSession;
    </script>
    
    <!--æ–°å¢è€ƒè¯•éƒ¨åˆ†-->
    <div id="upload-content" class="hidden">
      <div class="container mx-auto p-6">
        <form id="exam-form" class="space-y-6">
          <!-- åŸºæœ¬ä¿¡æ¯éƒ¨åˆ† -->
          <div class="border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">åŸºæœ¬ä¿¡æ¯</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label for="exam-name" class="block text-sm font-medium">è€ƒè¯•åç§°</label>
                <input type="text" 
                       id="exam-name" 
                       name="name"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š2024å¹´æ˜¥å­£æœŸä¸­è€ƒè¯•" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="subject" class="block text-sm font-medium">ç§‘ç›®</label>
                <input type="text" 
                       id="subject" 
                       name="subject"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼šäººå·¥æ™ºèƒ½åŸºç¡€" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="exam-time" class="block text-sm font-medium">è€ƒè¯•æ—¶é—´</label>
                <input type="datetime-local" 
                       id="exam-time" 
                       name="examTime"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       required />
              </div>
              <div class="space-y-2">
                <label for="duration" class="block text-sm font-medium">è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</label>
                <input type="number" 
                       id="duration" 
                       name="duration"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š120" 
                       required />
              </div>
              <div class="space-y-2">
                <label for="exam-score" class="block text-sm font-medium">è€ƒè¯•æ€»åˆ†å€¼</label>
                <input type="number" 
                       id="exam-score" 
                       name="examScore"
                       class="w-full bg-input text-foreground border border-border rounded-md px-3 py-2"
                       placeholder="ä¾‹å¦‚ï¼š100" 
                       required />
              </div>
            </div>
          </div>

          <!-- è¯•å·æ–‡ä»¶ä¸Šä¼ éƒ¨åˆ† -->
          <div class="border border-border rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-4">è¯•å·æ–‡ä»¶ <span class="text-sm font-normal text-muted-foreground">(å¯é€‰)</span></h3>
            <div class="space-y-4">
              <div class="space-y-2">
                <label for="exam-file" class="block text-sm font-medium">è¯•å·æ–‡ä»¶ï¼ˆPDFæ ¼å¼ï¼‰</label>
                <div class="border-2 border-dashed border-border rounded-lg p-6 text-center">
                  <input type="file" 
                         id="exam-file" 
                         name="examFile"
                         accept=".pdf"
                         class="hidden" />
                  <div id="file-drop-area" class="cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p class="mt-2 text-sm text-foreground font-medium">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</p>
                    <p id="file-name" class="mt-1 text-xs text-muted-foreground hidden"></p>
                    <p class="mt-1 text-xs text-muted-foreground">æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šPDF</p>
                  </div>
                </div>
                <p class="text-sm text-muted-foreground mt-1">è¯•å·æ–‡ä»¶ä¸ºå¯é€‰é¡¹ï¼Œå¯ä»¥ç¨åä¸Šä¼ </p>
              </div>
            </div>
          </div>

          <!-- æŒ‰é’®éƒ¨åˆ† -->
          <div class="flex justify-end space-x-4">
            <button type="button" 
                    onclick="window.location.href='/dashboard'"
                    class="bg-secondary text-secondary-foreground px-4 py-2 rounded-md">
              å–æ¶ˆ
            </button>
            <button type="submit" 
                    class="bg-primary text-primary-foreground px-6 py-2 rounded-md">
              åˆ›å»ºè€ƒè¯•
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('exam-form');
    const submitBtn = form ? form.querySelector('button[type="submit"]') : null;
    
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ç¦ç”¨æäº¤æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (submitBtn) {
                const originalText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="animate-spin inline-block mr-2">â³</span> åˆ›å»ºä¸­...';
            }
            
            try {
                const formData = new FormData(form);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ·»åŠ ä¸€ä¸ªæ ‡è®°
                const examFile = document.getElementById('exam-file').files[0];
                if (!examFile) {
                    formData.append('no_exam_file', 'true');
                }
                
                // æ‰“å°è¡¨å•æ•°æ®
                console.log('æäº¤çš„æ•°æ®:');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                const response = await fetch('/api/session', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showToast('è€ƒè¯•åˆ›å»ºæˆåŠŸï¼', 'success');
                    
                    // å»¶è¿Ÿè·³è½¬ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    throw new Error(data.error || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºè€ƒè¯•å¤±è´¥:', error);
                showToast(`åˆ›å»ºè€ƒè¯•å¤±è´¥: ${error.message}`, 'error');
                
                // æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'åˆ›å»ºè€ƒè¯•';
                }
            }
        });
    }
    
    // æ·»åŠ Toastæ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
    function showToast(message, type = 'info') {
        // åˆ›å»ºtoastå…ƒç´ 
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-2 rounded shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 
            type === 'error' ? 'bg-red-500 text-white' : 
            'bg-blue-500 text-white'
        }`;
        toast.textContent = message;
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(toast);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 500);
        }, 3000);
    }
});
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // é€‰é¡¹å¡åˆ‡æ¢åŠŸèƒ½
    const tabSessions = document.getElementById('tab-sessions');
    const tabUpload = document.getElementById('tab-upload');
    const sessionsContent = document.getElementById('sessions-content');
    const uploadContent = document.getElementById('upload-content');

    function switchTab(showSessions) {
      if (showSessions) {
        tabSessions.classList.add('border-primary', 'text-primary');
        tabSessions.classList.remove('border-transparent', 'text-muted-foreground');
        tabUpload.classList.remove('border-primary', 'text-primary');
        tabUpload.classList.add('border-transparent', 'text-muted-foreground');
        sessionsContent.classList.remove('hidden');
        uploadContent.classList.add('hidden');
      } else {
        tabUpload.classList.add('border-primary', 'text-primary');
        tabUpload.classList.remove('border-transparent', 'text-muted-foreground');
        tabSessions.classList.remove('border-primary', 'text-primary');
        tabSessions.classList.add('border-transparent', 'text-muted-foreground');
        uploadContent.classList.remove('hidden');
        sessionsContent.classList.add('hidden');
      }
    }

    tabSessions.addEventListener('click', () => switchTab(true));
    tabUpload.addEventListener('click', () => switchTab(false));

    // è€ƒè¯•åœºæ¬¡æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('search-sessions');
    const sessionList = document.getElementById('session-items');

    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const sessions = sessionList.getElementsByTagName('li');
      
      Array.from(sessions).forEach(session => {
        const text = session.textContent.toLowerCase();
        session.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });

    // ä¿å­˜è€ƒè¯•åœºæ¬¡
    const newSessionInput = document.getElementById('new-session-name');
    const saveSessionButton = document.getElementById('save-session-button');

    saveSessionButton.addEventListener('click', async function() {
      const sessionName = newSessionInput.value.trim();
      if (!sessionName) {
        alert('è¯·è¾“å…¥è€ƒè¯•åœºæ¬¡åç§°');
        return;
      }

      try {
        const response = await fetch('/api/session/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name: sessionName })
        });

        if (response.ok) {
          const result = await response.json();
          // æ·»åŠ æ–°çš„è€ƒè¯•åœºæ¬¡åˆ°åˆ—è¡¨
          const li = document.createElement('li');
          li.className = 'p-4 bg-muted/30 rounded-lg flex justify-between items-center';
          li.innerHTML = `
            <span>${sessionName}</span>
            <button class="text-destructive hover:text-destructive/80" onclick="deleteSession(${result.id})">
              åˆ é™¤
            </button>
          `;
          sessionList.appendChild(li);
          newSessionInput.value = '';
        } else {
          throw new Error('åˆ›å»ºå¤±è´¥');
        }
      } catch (error) {
        alert('åˆ›å»ºè€ƒè¯•åœºæ¬¡å¤±è´¥ï¼š' + error.message);
      }
    });

    // æ–‡ä»¶ä¸Šä¼ æ”¹è¿›
    const fileDropArea = document.getElementById('file-drop-area');
    const examFileInput = document.getElementById('exam-file');
    const fileName = document.getElementById('file-name');
    
    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
    if (fileDropArea) {
      fileDropArea.addEventListener('click', function() {
        examFileInput.click();
      });
    }
    
    // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
    if (fileDropArea) {
      fileDropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('border-primary', 'bg-primary/5');
      });
      
      fileDropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('border-primary', 'bg-primary/5');
      });
      
      fileDropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-primary', 'bg-primary/5');
        
        if (e.dataTransfer.files.length > 0) {
          const file = e.dataTransfer.files[0];
          if (file.type === 'application/pdf') {
            examFileInput.files = e.dataTransfer.files;
            updateFileName(file.name);
          } else {
            alert('è¯·ä¸Šä¼ PDFæ ¼å¼çš„æ–‡ä»¶');
          }
        }
      });
    }
    
    // æ–‡ä»¶é€‰æ‹©å˜åŒ–
    if (examFileInput) {
      examFileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          updateFileName(this.files[0].name);
        }
      });
    }
    
    // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º
    function updateFileName(name) {
      if (fileName) {
        fileName.textContent = 'å·²é€‰æ‹©: ' + name;
        fileName.classList.remove('hidden');
      }
    }
  });
</script>
{% endblock %}
