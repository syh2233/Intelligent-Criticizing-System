{% extends "base.html" %}

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">åœ¨çº¿è€ƒè¯•</h2>
    <p class="text-muted-foreground mb-6">æŸ¥çœ‹å¯ç”¨çš„è€ƒè¯•ï¼Œç‚¹å‡»è¿›å…¥å¼€å§‹ç­”é¢˜ã€‚</p>

    <!-- è€ƒè¯•ç­›é€‰å’Œæœç´¢ -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-4">
        <select id="status-filter" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm" onchange="applyFilters()">
          <option value="all">å…¨éƒ¨è€ƒè¯•</option>
          <option value="ongoing">è¿›è¡Œä¸­</option>
          <option value="pending">å³å°†å¼€å§‹</option>
          <option value="completed">å·²å®Œæˆ</option>
          <option value="graded">å·²è¯„åˆ†</option>
        </select>
        <div class="relative">
          <select id="subject-filter" class="bg-input text-foreground border border-border rounded-md px-3 py-2 pr-8 text-sm appearance-none cursor-pointer" onchange="applyFilters()">
            <option value="all">å…¨éƒ¨ç§‘ç›®</option>
            {% for subject in subjects %}
              <option value="{{ subject }}">{{ subject }}</option>
            {% endfor %}
          </select>
          <span class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">â–¼</span>
        </div>
      </div>
      <div class="relative">
        <input type="text" 
               id="exam-search"
               class="w-64 bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2"
               placeholder="æœç´¢è€ƒè¯•..." />
        <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
      </div>
    </div>

    <!-- è€ƒè¯•åˆ—è¡¨ -->
    <div class="space-y-4">
      <!-- è¿›è¡Œä¸­çš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">è¿›è¡Œä¸­çš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'ongoing' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                    <p class="text-sm text-muted-foreground">ç§‘ç›®ï¼š{{ exam.subject }}</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å‰©ä½™æ—¶é—´</p>
                      <p class="font-medium text-primary" data-end-time="{{ exam.end_time }}">è®¡ç®—ä¸­...</p>
                    </div>
                    <a href="{{ url_for('exam_with_id', exam_id=exam.id) }}" 
                       class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
                      è¿›å…¥è€ƒè¯•
                    </a>
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="p-4 text-center text-muted-foreground">
              å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„è€ƒè¯•
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- å³å°†å¼€å§‹çš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">å³å°†å¼€å§‹çš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'pending' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                    <p class="text-sm text-muted-foreground">ç§‘ç›®ï¼š{{ exam.subject }}</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å¼€å§‹æ—¶é—´</p>
                      <p class="font-medium">{{ exam.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    <button disabled 
                            class="bg-muted text-muted-foreground px-4 py-2 rounded-md cursor-not-allowed">
                      æœªå¼€å§‹
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="p-4 text-center text-muted-foreground">
              å½“å‰æ²¡æœ‰å³å°†å¼€å§‹çš„è€ƒè¯•
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- å·²å®Œæˆçš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">å·²å®Œæˆçš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'completed' or exam.status == 'graded' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                    <p class="text-sm text-muted-foreground">ç§‘ç›®ï¼š{{ exam.subject }}</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å¾—åˆ†</p>
                      <p class="font-medium text-primary">{{ exam.score if exam.score else 'æœªè¯„åˆ†' }}</p>
                    </div>
                    <a href="{{ url_for('exam_detail', exam_id=exam.id) }}" 
                      class="bg-secondary text-secondary-foreground px-4 py-2 rounded-md hover:bg-secondary/80 transition-colors duration-200">
                      æŸ¥çœ‹è¯¦æƒ…
                    </a>
                  </div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="p-4 text-center text-muted-foreground">
              å½“å‰æ²¡æœ‰å·²å®Œæˆçš„è€ƒè¯•
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // å…¨å±€å®šä¹‰ç­›é€‰å‡½æ•°ï¼Œä½¿å…¶å¯ä»HTMLå±æ€§ç›´æ¥è°ƒç”¨
  function applyFilters() {
    const status = document.getElementById('status-filter').value;
    const subject = document.getElementById('subject-filter').value;
    console.log('ç›´æ¥è°ƒç”¨ç­›é€‰å‡½æ•° - çŠ¶æ€:', status, 'ç§‘ç›®:', subject);
    
    // å¤„ç†è€ƒè¯•çŠ¶æ€ç­›é€‰
    const examSections = document.querySelectorAll('.border.border-border.rounded-lg.overflow-hidden');
    
    // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
    examSections.forEach(section => {
      section.style.display = '';
      section.querySelectorAll('.p-4').forEach(item => {
        item.style.display = '';
      });
      
      // ç§»é™¤ä¹‹å‰çš„æ— åŒ¹é…æ¶ˆæ¯
      section.querySelectorAll('.no-match-message').forEach(msg => {
        msg.remove();
      });
    });
    
    // çŠ¶æ€ç­›é€‰
    if (status !== 'all') {
      examSections.forEach(section => {
        const sectionTitle = section.querySelector('h3').textContent.trim();
        const shouldShow = (status === 'ongoing' && sectionTitle.includes('è¿›è¡Œä¸­')) ||
                          (status === 'pending' && sectionTitle.includes('å³å°†å¼€å§‹')) ||
                          ((status === 'completed' || status === 'graded') && sectionTitle.includes('å·²å®Œæˆ'));
        
        section.style.display = shouldShow ? '' : 'none';
      });
    }
    
    // ç§‘ç›®ç­›é€‰
    if (subject !== 'all') {
      examSections.forEach(section => {
        if (section.style.display !== 'none') {
          let hasMatches = false;
          const items = section.querySelectorAll('.p-4');
          
          items.forEach(item => {
            let examSubject = null;
            const subjectTexts = item.querySelectorAll('p');
            
            for (const p of subjectTexts) {
              if (p.textContent.includes('ç§‘ç›®ï¼š')) {
                examSubject = p.textContent.replace('ç§‘ç›®ï¼š', '').trim();
                break;
              }
            }
            
            const isMatch = examSubject === subject;
            item.style.display = isMatch ? '' : 'none';
            
            if (isMatch) {
              hasMatches = true;
            }
          });
          
          if (!hasMatches) {
            const noMatchMessage = document.createElement('div');
            noMatchMessage.className = 'p-4 text-center text-muted-foreground no-match-message';
            noMatchMessage.textContent = `æ²¡æœ‰åŒ¹é…"${subject}"çš„è€ƒè¯•`;
            section.querySelector('.divide-y').appendChild(noMatchMessage);
          }
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // æ›´æ–°å‰©ä½™æ—¶é—´
    function updateRemainingTime() {
      const timeElements = document.querySelectorAll('[data-end-time]');
      timeElements.forEach(element => {
        const endTime = new Date(element.dataset.endTime);
        const now = new Date();
        const diff = endTime - now;
        
        if (diff > 0) {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          element.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
          element.textContent = 'å·²ç»“æŸ';
        }
      });
    }

    // æ¯ç§’æ›´æ–°ä¸€æ¬¡å‰©ä½™æ—¶é—´
    setInterval(updateRemainingTime, 1000);
    updateRemainingTime(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡

    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('exam-search');
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        console.log('æœç´¢å…³é”®è¯:', searchTerm);
        
        // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
        const examSections = document.querySelectorAll('.border.border-border.rounded-lg.overflow-hidden');
        examSections.forEach(section => {
          section.style.display = '';
          // ç§»é™¤ä¹‹å‰çš„æ— åŒ¹é…æ¶ˆæ¯
          section.querySelectorAll('.no-match-message').forEach(msg => {
            msg.remove();
          });
        });
        
        // æ¸…æ™°åœ°æ ‡è¯†è€ƒè¯•é¡¹
        let allExamItems = document.querySelectorAll('.divide-y > div.p-4');
        console.log('æ‰¾åˆ°çš„è€ƒè¯•é¡¹æ€»æ•°:', allExamItems.length);
        
        // è·Ÿè¸ªæ¯ä¸ªåˆ†ç»„æ˜¯å¦æœ‰åŒ¹é…é¡¹
        let sectionMatches = {};
        
        // å…ˆåˆå§‹åŒ–åˆ†ç»„åŒ¹é…çŠ¶æ€
        examSections.forEach(section => {
          const sectionId = section.querySelector('h3').textContent.trim();
          sectionMatches[sectionId] = {
            section: section,
            hasMatches: false
          };
        });
        
        // å¯¹æ¯ä¸ªè€ƒè¯•é¡¹è¿›è¡Œç­›é€‰
        allExamItems.forEach(item => {
          // å¦‚æœæ˜¯"æ²¡æœ‰è€ƒè¯•"çš„å ä½ä¿¡æ¯ï¼Œè·³è¿‡
          if (item.classList.contains('text-center') && 
              item.textContent.includes('å½“å‰æ²¡æœ‰') && 
              !item.classList.contains('no-match-message')) {
            return;
          }
          
          const section = item.closest('.border.border-border.rounded-lg.overflow-hidden');
          const sectionId = section.querySelector('h3').textContent.trim();
          
          // æ£€æŸ¥é¡¹ç›®å†…å®¹æ˜¯å¦åŒ¹é…æœç´¢è¯
          const text = item.textContent.toLowerCase();
          const isMatch = text.includes(searchTerm);
          
          // æ˜¾ç¤º/éšè—åŒ¹é…é¡¹
          item.style.display = isMatch ? '' : 'none';
          
          // æ›´æ–°åˆ†ç»„åŒ¹é…çŠ¶æ€
          if (isMatch) {
            sectionMatches[sectionId].hasMatches = true;
          }
        });
        
        // ä¸ºæ²¡æœ‰åŒ¹é…é¡¹çš„åˆ†ç»„æ·»åŠ æç¤ºæ¶ˆæ¯
        Object.values(sectionMatches).forEach(({section, hasMatches}) => {
          if (!hasMatches && searchTerm.length > 0) {
            const divideY = section.querySelector('.divide-y');
            if (divideY && !divideY.querySelector('.no-match-message')) {
              const noMatchMessage = document.createElement('div');
              noMatchMessage.className = 'p-4 text-center text-muted-foreground no-match-message';
              noMatchMessage.textContent = `æ²¡æœ‰åŒ¹é…"${searchTerm}"çš„è€ƒè¯•`;
              divideY.appendChild(noMatchMessage);
            }
          }
        });
      });
    }

    // ä¿®å¤é¡¶éƒ¨ç­›é€‰ä¸‹æ‹‰èœå•åŠŸèƒ½ - ä½¿ç”¨æœ‰æ•ˆçš„é€‰æ‹©å™¨
    const statusDropdown = document.getElementById('status-filter');
    if (statusDropdown) {
      statusDropdown.addEventListener('change', function() {
        // ç›´æ¥åº”ç”¨ç­›é€‰
        applyFilters();
      });
    } else {
      console.error('æ‰¾ä¸åˆ°çŠ¶æ€ç­›é€‰æŒ‰é’®');
    }
  });
</script>
{% endblock %} 