{% extends "base.html" %}

{% block content %}
<div class="w-full max-w-4xl px-6">
  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4">åœ¨çº¿è€ƒè¯•</h2>
    <p class="text-muted-foreground mb-6">æŸ¥çœ‹å¯ç”¨çš„è€ƒè¯•ï¼Œç‚¹å‡»è¿›å…¥å¼€å§‹ç­”é¢˜ã€‚</p>

    <!-- è€ƒè¯•ç­›é€‰å’Œæœç´¢ -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center space-x-4">
        <select id="status-filter" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
          <option value="all">å…¨éƒ¨è€ƒè¯•</option>
          <option value="ongoing">è¿›è¡Œä¸­</option>
          <option value="upcoming">å³å°†å¼€å§‹</option>
          <option value="completed">å·²å®Œæˆ</option>
        </select>
        <select id="subject-filter" class="bg-input text-foreground border border-border rounded-md px-3 py-2 text-sm">
          <option value="all">å…¨éƒ¨ç§‘ç›®</option>
          <option value="ai">äººå·¥æ™ºèƒ½åŸºç¡€</option>
          <option value="math">é«˜ç­‰æ•°å­¦</option>
          <option value="english">å¤§å­¦è‹±è¯­</option>
        </select>
      </div>
      <div class="relative">
        <input type="text" 
               id="exam-search"
               class="w-64 bg-input text-foreground border border-border rounded-md pl-8 pr-3 py-2"
               placeholder="æœç´¢è€ƒè¯•..." />
        <span class="absolute left-2.5 top-2.5 text-muted-foreground">ğŸ”</span>
      </div>
    </div>

    <!-- è€ƒè¯•åˆ—è¡¨ -->
    <div class="space-y-4">
      <!-- è¿›è¡Œä¸­çš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">è¿›è¡Œä¸­çš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'ongoing' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å‰©ä½™æ—¶é—´</p>
                      <p class="font-medium text-primary" data-end-time="{{ exam.end_time }}">è®¡ç®—ä¸­...</p>
                    </div>
                    <a href="{{ url_for('exam', exam_id=exam.id) }}" 
                       class="bg-primary text-primary-foreground px-4 py-2 rounded-md hover:bg-primary/80 transition-colors duration-200">
                      è¿›å…¥è€ƒè¯•
                    </a>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- å³å°†å¼€å§‹çš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">å³å°†å¼€å§‹çš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'upcoming' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å¼€å§‹æ—¶é—´</p>
                      <p class="font-medium">{{ exam.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    <button disabled 
                            class="bg-muted text-muted-foreground px-4 py-2 rounded-md cursor-not-allowed">
                      æœªå¼€å§‹
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- å·²å®Œæˆçš„è€ƒè¯• -->
      <div class="border border-border rounded-lg overflow-hidden">
        <div class="bg-muted/30 px-4 py-2">
          <h3 class="font-semibold">å·²å®Œæˆçš„è€ƒè¯•</h3>
        </div>
        <div class="divide-y divide-border">
          {% for exam in exams %}
            {% if exam.status == 'completed' %}
              <div class="p-4 hover:bg-muted/10 transition-colors duration-200">
                <div class="flex items-center justify-between">
                  <div class="space-y-1">
                    <h4 class="font-medium">{{ exam.name }}</h4>
                    <p class="text-sm text-muted-foreground">è€ƒè¯•æ—¶é•¿ï¼š{{ exam.duration }}åˆ†é’Ÿ | æ€»åˆ†ï¼š{{ exam.total_score }}åˆ†</p>
                  </div>
                  <div class="flex items-center space-x-4">
                    <div class="text-right">
                      <p class="text-sm text-muted-foreground">å¾—åˆ†</p>
                      <p class="font-medium text-primary">{{ exam.score }}</p>
                    </div>
                    <button onclick="window.location.href='{{ url_for('exam_detail', exam_id=exam.id) }}'" 
                            class="bg-secondary text-secondary-foreground px-4 py-2 rounded-md hover:bg-secondary/80 transition-colors duration-200">
                      æŸ¥çœ‹è¯¦æƒ…
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // æ›´æ–°å‰©ä½™æ—¶é—´
    function updateRemainingTime() {
      const timeElements = document.querySelectorAll('[data-end-time]');
      timeElements.forEach(element => {
        const endTime = new Date(element.dataset.endTime);
        const now = new Date();
        const diff = endTime - now;
        
        if (diff > 0) {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          element.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
          element.textContent = 'å·²ç»“æŸ';
        }
      });
    }

    // æ¯ç§’æ›´æ–°ä¸€æ¬¡å‰©ä½™æ—¶é—´
    setInterval(updateRemainingTime, 1000);
    updateRemainingTime(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡

    // æœç´¢åŠŸèƒ½
    const searchInput = document.getElementById('exam-search');
    searchInput.addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const examItems = document.querySelectorAll('.p-4');
      
      examItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });

    // ç­›é€‰åŠŸèƒ½
    const statusFilter = document.getElementById('status-filter');
    const subjectFilter = document.getElementById('subject-filter');

    function applyFilters() {
      const status = statusFilter.value;
      const subject = subjectFilter.value;
      const examItems = document.querySelectorAll('.p-4');
      
      examItems.forEach(item => {
        const examStatus = item.closest('.border').querySelector('h3').textContent.includes('è¿›è¡Œä¸­') ? 'ongoing' :
                          item.closest('.border').querySelector('h3').textContent.includes('å³å°†å¼€å§‹') ? 'upcoming' : 'completed';
        const examSubject = item.querySelector('h4').textContent;
        
        const statusMatch = status === 'all' || examStatus === status;
        const subjectMatch = subject === 'all' || examSubject.includes(subject === 'ai' ? 'äººå·¥æ™ºèƒ½' : 
                                                                      subject === 'math' ? 'é«˜ç­‰æ•°å­¦' : 'å¤§å­¦è‹±è¯­');
        
        item.style.display = statusMatch && subjectMatch ? '' : 'none';
      });
    }

    statusFilter.addEventListener('change', applyFilters);
    subjectFilter.addEventListener('change', applyFilters);
  });
</script>
{% endblock %} 